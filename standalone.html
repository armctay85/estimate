<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EstiMate - Professional Construction Cost Estimator & Takeoff Tool Australia</title>
  <meta name="description" content="Professional construction cost estimator and takeoff tool for Australian builders, contractors, and quantity surveyors. Calculate material costs, measure floor plans, and generate accurate construction estimates. Free online tool with advanced features.">
  <meta name="keywords" content="construction estimator, takeoff tool, cost calculator, Australian builders, quantity surveyor, floor plan measurement, material costs, construction quotes, building estimator, contractor tools">
  <meta name="author" content="EstiMate">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://estimate-construction.replit.app/standalone.html">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://estimate-construction.replit.app/standalone.html">
  <meta property="og:title" content="EstiMate - Professional Construction Cost Estimator Australia">
  <meta property="og:description" content="Free professional construction estimator and takeoff tool for Australian builders. Calculate material costs, measure floor plans, generate accurate quotes.">
  <meta property="og:image" content="https://estimate-construction.replit.app/og-image.jpg">
  <meta property="og:site_name" content="EstiMate">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://estimate-construction.replit.app/standalone.html">
  <meta property="twitter:title" content="EstiMate - Professional Construction Cost Estimator Australia">
  <meta property="twitter:description" content="Free professional construction estimator and takeoff tool for Australian builders. Calculate material costs, measure floor plans, generate accurate quotes.">
  <meta property="twitter:image" content="https://estimate-construction.replit.app/og-image.jpg">
  
  <!-- Geo Tags -->
  <meta name="geo.region" content="AU">
  <meta name="geo.country" content="Australia">
  <meta name="geo.placename" content="Australia">
  
  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "EstiMate",
    "description": "Professional construction cost estimator and takeoff tool for Australian builders and contractors",
    "url": "https://estimate-construction.replit.app/standalone.html",
    "applicationCategory": "BusinessApplication",
    "operatingSystem": "Web Browser",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "AUD"
    },
    "creator": {
      "@type": "Organization",
      "name": "EstiMate",
      "url": "https://estimate-construction.replit.app"
    },
    "featureList": [
      "Construction cost estimation",
      "Floor plan takeoff",
      "Material cost calculation",
      "Australian building costs",
      "CSV export",
      "Project management"
    ],
    "screenshot": "https://estimate-construction.replit.app/app-screenshot.jpg"
  }
  </script>
  
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%232563eb' rx='4'/><path d='M8 12h16v2H8zm0 4h12v2H8zm0 4h16v2H8z' fill='white'/></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%232563eb' rx='20'/><path d='M40 60h100v10H40zm0 20h80v10H40zm0 20h100v10H40z' fill='white'/></svg>">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #f97316;
      --accent: #10b981;
      --surface: #ffffff;
      --surface-2: #f8fafc;
      --border: #e2e8f0;
      --text: #1e293b;
      --text-muted: #64748b;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding: 16px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 12px;
      color: white;
      box-shadow: var(--shadow-lg);
    }
    
    .logo-icon {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    .logo-text h1 {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.025em;
    }
    
    .logo-text p {
      font-size: 13px;
      margin: 0;
      opacity: 0.9;
      font-weight: 400;
    }
    
    .sidebar { 
      width: 340px; 
      background: var(--surface);
      border-right: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    
    .canvas-container { 
      flex: 1; 
      position: relative; 
      background: var(--surface-2);
    }
    
    #canvas { 
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: 8px;
      box-shadow: var(--shadow);
    }
    
    .section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .tool-btn { 
      transition: all 0.2s ease;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      border-radius: 8px;
      padding: 12px 16px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .tool-btn:hover { 
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }
    
    .tool-btn.active { 
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-color: var(--primary);
      box-shadow: var(--shadow-lg);
    }
    
    .premium-feature { 
      opacity: 0.7; 
      pointer-events: none; 
      position: relative; 
    }
    
    .premium-feature::after { 
      content: 'Pro'; 
      position: absolute; 
      top: 0; 
      right: 0; 
      background: linear-gradient(135deg, var(--secondary), #ea580c);
      color: white;
      padding: 4px 8px; 
      font-size: 10px; 
      border-radius: 0 8px 0 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .material-btn {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      transition: all 0.2s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .material-btn:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }
    
    .material-btn.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-lg);
    }
    
    .room-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    
    .room-item:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }
    
    .cost-display {
      background: linear-gradient(135deg, var(--accent), #059669);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: var(--shadow-lg);
    }
    
    .cost-amount {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .cost-label {
      font-size: 14px;
      opacity: 0.9;
      font-weight: 500;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .btn-secondary:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }
    
    .input-field {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      background: var(--surface);
      transition: all 0.2s ease;
      font-weight: 500;
    }
    
    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .ad-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, var(--text), var(--text-muted));
      color: white;
      padding: 12px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      box-shadow: var(--shadow-lg);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-slide-in {
      animation: slideIn 0.3s ease-out;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="sidebar p-4 overflow-y-auto">
      <div class="logo animate-slide-in">
        <div class="logo-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 7h-3V4a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3H5a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1zM10 6h4v1h-4V6zm8 12H6V9h2v1a1 1 0 0 0 2 0V9h4v1a1 1 0 0 0 2 0V9h2v9z"/>
            <path d="M8 11h2v2H8zm4 0h2v2h-2zm4 0h2v2h-2zm-8 4h2v2H8zm4 0h2v2h-2z"/>
          </svg>
        </div>
        <div class="logo-text">
          <h1>EstiMate</h1>
          <p>Australian Construction Cost Estimator</p>
        </div>
      </div>
      
      <!-- Tools -->
      <div class="mb-6">
        <h2 class="font-semibold mb-3 text-gray-700">Drawing Tools</h2>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="setShape('rectangle')" class="tool-btn bg-gray-200 hover:bg-gray-300 p-3 rounded-lg text-sm font-medium" id="rect-btn">Rectangle</button>
          <button onclick="setShape('circle')" class="tool-btn bg-gray-200 hover:bg-gray-300 p-3 rounded-lg text-sm font-medium" id="circle-btn">Circle</button>
          <button onclick="setShape('polygon')" class="tool-btn bg-gray-200 hover:bg-gray-300 p-3 rounded-lg text-sm font-medium" id="polygon-btn">Polygon</button>
          <button onclick="setShape('line')" class="tool-btn bg-gray-200 hover:bg-gray-300 p-3 rounded-lg text-sm font-medium" id="line-btn">Line</button>
          <button onclick="setShape('freehand')" class="tool-btn bg-gray-200 hover:bg-gray-300 p-3 rounded-lg text-sm font-medium" id="freehand-btn">Freehand</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">💡 Polygon: Click points, double-click to finish</p>
      </div>
      
      <!-- Materials -->
      <div class="section animate-slide-in">
        <div class="section-title">
          <div class="section-icon">🏗️</div>
          Material Library
        </div>
        
        <!-- Project Type Selection -->
        <div class="mb-3">
          <select id="project-type-select" onchange="setProjectType(this.value)" class="input-field w-full">
            <option value="residential">Residential Project</option>
            <option value="commercial">Commercial Project</option>
          </select>
        </div>
        
        <!-- Material Categories -->
        <div class="mb-3">
          <select id="category-select" onchange="filterMaterialsByCategory(this.value)" class="input-field w-full">
            <option value="all">All Categories</option>
            <option value="flooring">Flooring</option>
            <option value="structural">Structural (Pro)</option>
            <option value="walls">Walls & Partitions (Pro)</option>
            <option value="roofing">Roofing (Pro)</option>
            <option value="external">External (Pro)</option>
            <option value="internal">Internal (Pro)</option>
            <option value="fitout">Fitout (Pro)</option>
          </select>
        </div>
        
        <select id="material-select" onchange="setMaterial(this.value)" class="input-field w-full mb-3">
          <!-- Will be populated by JavaScript based on project type -->
        </select>
        
        <!-- Material Details (Pro Feature) -->
        <div id="material-details" class="bg-blue-50 p-3 rounded-lg text-sm premium-feature">
          <div class="font-semibold mb-2">Cost Breakdown</div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div>Material: <span id="mat-material-cost">$0</span></div>
            <div>Labor: <span id="mat-labor-cost">$0</span></div>
            <div>Wastage: <span id="mat-wastage">0%</span></div>
            <div>Total: <span id="mat-total-cost">$0</span></div>
          </div>
        </div>
        
        <!-- Add Custom Material -->
        <details class="mt-3">
          <summary class="text-sm text-primary cursor-pointer font-medium">Add Custom Material</summary>
          <div class="mt-3 space-y-3">
            <input id="custom-mat-name" placeholder="Material name" class="input-field w-full">
            <select id="custom-mat-category" class="input-field w-full">
              <option value="flooring">Flooring</option>
              <option value="structural">Structural</option>
              <option value="external">External</option>
              <option value="internal">Internal</option>
              <option value="fitout">Fitout</option>
            </select>
            <div class="grid grid-cols-2 gap-2">
              <input id="custom-mat-color" type="color" value="#8B4513" class="input-field">
              <select id="custom-mat-unit" class="input-field">
                <option value="m²">m²</option>
                <option value="m³">m³</option>
                <option value="each">each</option>
                <option value="tonne">tonne</option>
                <option value="lm">linear m</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <input id="custom-mat-material-cost" placeholder="Material $/unit" type="number" class="input-field">
              <input id="custom-mat-labor-cost" placeholder="Labor $/unit" type="number" class="input-field">
            </div>
            <input id="custom-mat-wastage" placeholder="Wastage % (e.g. 10)" type="number" class="input-field">
            <button onclick="addCustomMaterial()" class="btn-primary w-full">Add Material</button>
          </div>
        </details>
      </div>
      
      <!-- Templates -->
      <div class="mb-6">
        <h2 class="font-semibold mb-3 text-gray-700">Quick Templates</h2>
        <select id="template-select" class="w-full p-2 border rounded-lg mb-2 text-sm">
          <option value="">Select a template...</option>
        </select>
        <button onclick="addTemplate()" class="bg-purple-500 hover:bg-purple-600 text-white p-2 rounded-lg w-full text-sm font-medium">Add Template</button>
      </div>
      
      <!-- Rooms List -->
      <div class="mb-6">
        <h2 class="font-semibold mb-3 text-gray-700">Project Elements</h2>
        <div id="rooms-list" class="max-h-64 overflow-y-auto"></div>
      </div>
      
      <!-- Cost Summary -->
      <div class="section animate-slide-in">
        <div class="section-title">
          <div class="section-icon">💰</div>
          Cost Summary
        </div>
        
        <!-- Basic Cost Display -->
        <div class="cost-display mb-4">
          <div class="cost-amount" id="total-cost">$0 AUD</div>
          <div class="cost-label">Total Project Cost</div>
        </div>
        
        <!-- Detailed Cost Breakdown (Pro) -->
        <div id="cost-breakdown" class="premium-feature">
          <div class="bg-white border border-gray-200 rounded-lg p-4">
            <h4 class="font-semibold mb-3">Professional Cost Breakdown</h4>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span>Materials:</span>
                <span id="cost-materials">$0</span>
              </div>
              <div class="flex justify-between">
                <span>Labor:</span>
                <span id="cost-labor">$0</span>
              </div>
              <div class="flex justify-between">
                <span>Wastage:</span>
                <span id="cost-wastage">$0</span>
              </div>
              <div class="flex justify-between">
                <span>MEP Services:</span>
                <span id="cost-services">$0</span>
              </div>
              <div class="flex justify-between border-t pt-2">
                <span class="font-semibold">Subtotal:</span>
                <span id="cost-subtotal" class="font-semibold">$0</span>
              </div>
              <div class="flex justify-between">
                <span>Overheads (15%):</span>
                <span id="cost-overheads">$0</span>
              </div>
              <div class="flex justify-between">
                <span>Profit (12%):</span>
                <span id="cost-profit">$0</span>
              </div>
              <div class="flex justify-between">
                <span>Contingency (8%):</span>
                <span id="cost-contingency">$0</span>
              </div>
              <div class="flex justify-between border-t pt-2">
                <span class="font-semibold">Ex GST:</span>
                <span id="cost-ex-gst" class="font-semibold">$0</span>
              </div>
              <div class="flex justify-between">
                <span>GST (10%):</span>
                <span id="cost-gst">$0</span>
              </div>
              <div class="flex justify-between border-t pt-2 text-lg font-bold">
                <span>TOTAL INC GST:</span>
                <span id="cost-total-inc-gst">$0</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Site Costs (Pro) -->
      <div class="section animate-slide-in premium-feature">
        <div class="section-title">
          <div class="section-icon">🏗️</div>
          Site Costs & Mobilization
        </div>
        
        <div id="site-costs-list" class="space-y-2">
          <!-- Will be populated by JavaScript -->
        </div>
        
        <button onclick="showSiteCostsModal()" class="btn-secondary w-full mt-3">
          Manage Site Costs
        </button>
      </div>
      
      <!-- Enterprise BIM Auto-Takeoff -->
      <div class="section animate-slide-in enterprise-feature" style="border: 2px solid #gold; background: linear-gradient(135deg, #fff8dc 0%, #fffef7 100%);">
        <div class="section-title">
          <div class="section-icon">🤖</div>
          BIM Auto-Takeoff (Enterprise)
        </div>
        
        <div class="bg-white border border-amber-200 rounded-lg p-3 mb-3">
          <div class="text-sm font-semibold mb-2 text-amber-800">Upload CAD/BIM Files</div>
          <input type="file" id="cad-upload" multiple accept=".dwg,.dxf,.ifc,.rvt,.skp,.pln,.pdf" class="input-field w-full mb-2" onchange="processCadFiles(this.files)">
          <div class="text-xs text-amber-600">Supports: DWG, DXF, IFC, Revit, SketchUp, ArchiCAD, PDF</div>
        </div>
        
        <div id="processing-status" class="mb-3" style="display: none;">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <div class="text-sm font-semibold text-blue-800">Processing CAD Files...</div>
            <div class="w-full bg-blue-200 rounded-full h-2 mt-2">
              <div id="progress-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
            </div>
            <div id="progress-text" class="text-xs text-blue-600 mt-1">Initializing AI analysis...</div>
          </div>
        </div>
        
        <div id="takeoff-results" class="space-y-2 mb-3">
          <!-- Will be populated with automated results -->
        </div>
        
        <button onclick="showBimCapabilities()" class="btn-secondary w-full mb-2">
          View BIM Capabilities
        </button>
        <button onclick="generateQsReport()" class="btn-primary w-full mb-2">
          Generate QS Report
        </button>
        <button onclick="showRatesSchedule()" class="btn-secondary w-full">
          View Rates Schedule
        </button>
      </div>
      
      <!-- MEP Services (Pro) -->
      <div class="section animate-slide-in premium-feature">
        <div class="section-title">
          <div class="section-icon">⚡</div>
          MEP Services
        </div>
        
        <div class="bg-white border border-gray-200 rounded-lg p-3 mb-3">
          <div class="text-sm font-semibold mb-2">Total Building Area (m²)</div>
          <input type="number" id="building-area" placeholder="Enter total area" class="input-field w-full" onchange="updateServicesCosts()">
        </div>
        
        <div id="services-list" class="space-y-2 mb-3">
          <!-- Will be populated by JavaScript -->
        </div>
        
        <button onclick="showServicesModal()" class="btn-secondary w-full mb-3">
          Configure Services
        </button>
      </div>
      
      <!-- Labor Management (Pro) -->
      <div class="section animate-slide-in premium-feature">
        <div class="section-title">
          <div class="section-icon">👷</div>
          Labor & Trades
        </div>
        
        <div class="bg-white border border-gray-200 rounded-lg p-3">
          <div class="text-sm text-gray-600 mb-2">Current Labor Rates ($/hour)</div>
          <div class="grid grid-cols-2 gap-1 text-xs">
            <div>Carpenter: $65</div>
            <div>Bricklayer: $70</div>
            <div>Electrician: $85</div>
            <div>Plumber: $80</div>
            <div>Painter: $55</div>
            <div>Project Mgr: $95</div>
          </div>
        </div>
        
        <button onclick="showLaborRatesModal()" class="btn-secondary w-full mt-3">
          Manage Labor Rates
        </button>
      </div>
      
      <!-- Measurement & Scale -->
      <div class="mb-6 border-t pt-4">
        <h2 class="font-semibold mb-3 text-gray-700">Measurement & Scale</h2>
        <div class="bg-blue-50 p-3 rounded-lg mb-3">
          <p class="text-xs text-blue-800 mb-2">Current Scale: <span id="scale-display">100 pixels = 1m</span></p>
          <button onclick="startCalibration()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg w-full text-sm font-medium">Calibrate Scale</button>
        </div>
      </div>

      <!-- Controls -->
      <div class="mb-6">
        <h2 class="font-semibold mb-3 text-gray-700">Canvas Controls</h2>
        <div class="grid grid-cols-2 gap-2 mb-3">
          <button onclick="addElement()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg text-sm font-medium">Add Element</button>
          <button onclick="clearCanvas()" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg text-sm font-medium">Clear All</button>
          <button onclick="toggleGrid()" class="bg-gray-500 hover:bg-gray-600 text-white p-2 rounded-lg text-sm font-medium">Toggle Grid</button>
          <button onclick="zoomToFit()" class="bg-gray-500 hover:bg-gray-600 text-white p-2 rounded-lg text-sm font-medium">Zoom Fit</button>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="zoomIn()" class="bg-gray-500 hover:bg-gray-600 text-white p-2 rounded-lg text-sm font-medium">Zoom +</button>
          <button onclick="zoomOut()" class="bg-gray-500 hover:bg-gray-600 text-white p-2 rounded-lg text-sm font-medium">Zoom -</button>
        </div>
      </div>
      
      <!-- Background -->
      <div class="mb-6">
        <h2 class="font-semibold mb-3 text-gray-700">Base Layer</h2>
        <input type="file" id="bg-file" onchange="loadBackground()" class="w-full mb-2 text-sm" accept=".pdf,.dwg,.dxf,.jpg,.jpeg,.png">
        <button onclick="removeBackground()" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg w-full mb-3 text-sm font-medium">Remove Background</button>
        <label class="block text-sm text-gray-600">
          Opacity: 
          <input type="range" min="0" max="1" step="0.1" value="0.7" onchange="setBgOpacity(this.value)" class="w-full">
        </label>
      </div>
      
      <!-- Export/Save -->
      <div class="mb-6">
        <h2 class="font-semibold mb-3 text-gray-700">Export & Save</h2>
        <button onclick="exportToPDF()" class="bg-green-500 text-white p-2 rounded-lg w-full mb-2 text-sm font-medium premium-feature">Export PDF Report</button>
        <button onclick="exportToCSV()" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-lg w-full mb-2 text-sm font-medium">Export CSV</button>
        <button onclick="saveProject()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg w-full mb-2 text-sm font-medium">Save Project</button>
        <input type="file" id="load-file" onchange="loadProject()" class="w-full text-sm" accept=".json">
      </div>
      
      <!-- Premium Features -->
      <div class="section">
        <div class="section-title">
          <div class="section-icon">⭐</div>
          EstiMate Pro - Quantity Surveyor Edition
        </div>
        
        <div class="cost-display mb-4">
          <div class="cost-amount">$39.99</div>
          <div class="cost-label">per month</div>
        </div>
        
        <button onclick="subscribe()" class="btn-primary w-full mb-4">
          Upgrade to Pro QS
        </button>
        
        <div class="space-y-3 text-sm">
          <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-300 rounded-lg p-3 mb-3">
            <h4 class="font-semibold mb-2 text-amber-800">🤖 Enterprise BIM Auto-Takeoff</h4>
            <div class="text-xs font-bold text-amber-900 mb-2">Replace a Quantity Surveyor - $2,999/month</div>
            <ul class="space-y-1 text-xs text-amber-700">
              <li>🎯 Automated CAD/BIM file processing</li>
              <li>🤖 AI-powered element detection & classification</li>
              <li>📐 ±2% measurement accuracy guarantee</li>
              <li>⚡ 15-45 minute complete takeoff generation</li>
              <li>📊 AIQS standard elemental cost plans</li>
              <li>🔍 Clash detection & design optimization</li>
              <li>📈 Multi-option cost comparison analysis</li>
              <li>🎯 Procurement-ready BOM schedules</li>
              <li>🔗 API integration with major BIM platforms</li>
              <li>👨‍🏫 Full training & implementation support</li>
            </ul>
            <div class="mt-2 text-xs font-semibold text-amber-800">
              Formats: DWG, DXF, IFC, Revit, SketchUp, ArchiCAD
            </div>
          </div>
          
          <div class="bg-white border border-gray-200 rounded-lg p-3">
            <h4 class="font-semibold mb-2">Professional QS Features</h4>
            <ul class="space-y-1 text-xs">
              <li>✅ Complete Australian material library (200+ items)</li>
              <li>✅ Residential vs Commercial project modes</li>
              <li>✅ Full built form: structure, walls, roofing</li>
              <li>✅ MEP services: electrical, plumbing, HVAC</li>
              <li>✅ Fire services & sprinkler systems</li>
              <li>✅ Detailed labor cost breakdown by trade</li>
              <li>✅ Site mobilization & running costs</li>
              <li>✅ Project overheads & profit margins</li>
              <li>✅ GST and contingency calculations</li>
              <li>✅ Professional cost plan reports</li>
            </ul>
          </div>
          
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <h4 class="font-semibold mb-2 text-blue-800">Pro Features ($39.99/month)</h4>
            <ul class="space-y-1 text-xs text-blue-700">
              <li>🏗️ 200+ Australian construction materials & systems</li>
              <li>🏠 Residential: ducted heating, hydronic, split AC</li>
              <li>🏢 Commercial: HVAC, VRF, sprinklers, BMS</li>
              <li>⚡ Complete MEP services integration</li>
              <li>👷 15+ trade-specific labor rates</li>
              <li>📊 Professional quantity surveyor reports</li>
              <li>💼 Complete commercial cost planning</li>
              <li>📈 Regional cost variations (all states)</li>
            </ul>
          </div>
          
          <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-lg p-3">
            <h4 class="font-semibold mb-2 text-purple-800">Enterprise Tier Features</h4>
            <ul class="space-y-1 text-xs text-purple-700">
              <li>🤖 Complete BIM Auto-Takeoff system</li>
              <li>💰 Replace entire QS department</li>
              <li>⚡ 90% faster than manual takeoffs</li>
              <li>🎯 Industry-leading ±2% accuracy</li>
              <li>📋 AIQS compliant cost plans</li>
              <li>🔗 Full API integration capabilities</li>
              <li>👨‍💼 Dedicated account management</li>
              <li>🎓 Complete team training included</li>
            </ul>
            <div class="mt-2 p-2 bg-purple-100 rounded text-xs font-semibold text-purple-800">
              Contact for Enterprise Demo: $15k setup + $2,999/month
            </div>
          </div>
        </div>
      </div>
      
      <!-- Share -->
      <div>
        <h2 class="font-semibold mb-3 text-gray-700">Share Project</h2>
        <button onclick="shareProject()" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-lg w-full text-sm font-medium">Generate Share Link</button>
      </div>
    </div>
    
    <!-- Canvas -->
    <div class="canvas-container flex flex-col">
      <div class="p-4 bg-white border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold text-gray-700">Drawing Canvas</h3>
          <div class="text-sm text-gray-500">
            Drag to draw shapes • Shift+click to pan • Scroll to zoom
          </div>
        </div>
      </div>
      <div class="flex-1 p-4">
        <canvas id="canvas" class="rounded-lg shadow-sm"></canvas>
        
        <!-- SEO Content Section -->
        <div class="mt-8 bg-white p-6 rounded-lg shadow-sm border">
          <h3 class="text-lg font-semibold mb-4 text-gray-800">About EstiMate - Australia's Leading Construction Cost Estimator</h3>
          <div class="grid md:grid-cols-2 gap-6 text-sm text-gray-600">
            <div>
              <h4 class="font-semibold text-gray-800 mb-2">For Australian Builders & Contractors</h4>
              <p>EstiMate is specifically designed for the Australian construction industry, featuring local material costs, metric measurements, and compliance with Australian building standards. Perfect for residential builders, commercial contractors, and quantity surveyors across NSW, VIC, QLD, WA, SA, TAS, ACT, and NT.</p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-800 mb-2">Professional Takeoff Features</h4>
              <ul class="space-y-1">
                <li>• Accurate floor plan measurement tools</li>
                <li>• Real-time material cost calculation</li>
                <li>• Australian standard building materials</li>
                <li>• CSV export for quotes and estimates</li>
                <li>• Calibrated scaling for precise measurements</li>
                <li>• Template library for common room types</li>
              </ul>
            </div>
          </div>
          
          <div class="mt-6 pt-4 border-t">
            <h4 class="font-semibold text-gray-800 mb-2">Construction Cost Categories</h4>
            <div class="flex flex-wrap gap-2">
              <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs">Flooring Costs</span>
              <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs">Timber Flooring</span>
              <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs">Carpet Installation</span>
              <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-xs">Tile Laying</span>
              <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs">Laminate Flooring</span>
              <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs">Vinyl Planks</span>
            </div>
          </div>
          
          <div class="mt-6 pt-4 border-t">
            <h4 class="font-semibold text-gray-800 mb-2">How to Use EstiMate for Construction Estimates</h4>
            <ol class="space-y-2 text-sm">
              <li><strong>1. Draw Your Floor Plan:</strong> Use our intuitive drawing tools to sketch rooms, walls, and spaces directly on the canvas.</li>
              <li><strong>2. Select Materials:</strong> Choose from Australian standard materials including timber, carpet, tiles, laminate, and vinyl flooring.</li>
              <li><strong>3. Calibrate Scale:</strong> Set accurate measurements by calibrating the scale to real-world dimensions.</li>
              <li><strong>4. Calculate Costs:</strong> Get instant cost estimates based on current Australian material prices and labor rates.</li>
              <li><strong>5. Export Reports:</strong> Generate professional CSV reports for client quotes and project documentation.</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Australian Materials with comprehensive cost breakdown
    let MATERIALS = {
      // Flooring Materials
      timber: { 
        color: '#D2B48C', 
        materialCost: 85, 
        laborCost: 35, 
        wastage: 0.10,
        category: 'flooring',
        unit: 'm²',
        description: 'Premium hardwood flooring'
      },
      carpet: { 
        color: '#8B4513', 
        materialCost: 25, 
        laborCost: 18, 
        wastage: 0.08,
        category: 'flooring',
        unit: 'm²',
        description: 'Commercial grade carpet'
      },
      tiles: { 
        color: '#708090', 
        materialCost: 45, 
        laborCost: 25, 
        wastage: 0.12,
        category: 'flooring',
        unit: 'm²',
        description: 'Ceramic/porcelain tiles'
      },
      laminate: { 
        color: '#DEB887', 
        materialCost: 22, 
        laborCost: 12, 
        wastage: 0.06,
        category: 'flooring',
        unit: 'm²',
        description: 'Quality laminate flooring'
      },
      vinyl: { 
        color: '#2F4F4F', 
        materialCost: 18, 
        laborCost: 10, 
        wastage: 0.05,
        category: 'flooring',
        unit: 'm²',
        description: 'Luxury vinyl planks'
      },
      
      // Pro Materials - Structural
      concrete_slab: {
        color: '#A9A9A9',
        materialCost: 120,
        laborCost: 45,
        wastage: 0.05,
        category: 'structural',
        unit: 'm²',
        description: 'Reinforced concrete slab',
        isPro: true,
        residential: true,
        commercial: true
      },
      concrete_footing: {
        color: '#696969',
        materialCost: 180,
        laborCost: 65,
        wastage: 0.08,
        category: 'structural',
        unit: 'm³',
        description: 'Concrete strip footings',
        isPro: true,
        residential: true,
        commercial: true
      },
      steel_frame: {
        color: '#4682B4',
        materialCost: 850,
        laborCost: 380,
        wastage: 0.08,
        category: 'structural',
        unit: 'tonne',
        description: 'Structural steel framing',
        isPro: true,
        residential: false,
        commercial: true
      },
      timber_frame: {
        color: '#8B7355',
        materialCost: 1200,
        laborCost: 450,
        wastage: 0.12,
        category: 'structural',
        unit: 'm³',
        description: 'Timber frame construction',
        isPro: true,
        residential: true,
        commercial: false
      },
      precast_concrete: {
        color: '#B0C4DE',
        materialCost: 280,
        laborCost: 120,
        wastage: 0.05,
        category: 'structural',
        unit: 'm²',
        description: 'Precast concrete panels',
        isPro: true,
        residential: false,
        commercial: true
      },
      
      // Walls & Partitions
      masonry_wall: {
        color: '#CD853F',
        materialCost: 95,
        laborCost: 85,
        wastage: 0.10,
        category: 'walls',
        unit: 'm²',
        description: 'Double brick cavity wall',
        isPro: true,
        residential: true,
        commercial: true
      },
      stud_wall_residential: {
        color: '#DEB887',
        materialCost: 35,
        laborCost: 28,
        wastage: 0.08,
        category: 'walls',
        unit: 'm²',
        description: 'Timber stud wall (residential)',
        isPro: true,
        residential: true,
        commercial: false
      },
      steel_stud_wall: {
        color: '#C0C0C0',
        materialCost: 42,
        laborCost: 32,
        wastage: 0.08,
        category: 'walls',
        unit: 'm²',
        description: 'Steel stud wall (commercial)',
        isPro: true,
        residential: false,
        commercial: true
      },
      glazed_curtain_wall: {
        color: '#87CEEB',
        materialCost: 380,
        laborCost: 220,
        wastage: 0.05,
        category: 'walls',
        unit: 'm²',
        description: 'Glazed curtain wall system',
        isPro: true,
        residential: false,
        commercial: true
      },
      demountable_partition: {
        color: '#F5F5DC',
        materialCost: 125,
        laborCost: 45,
        wastage: 0.05,
        category: 'walls',
        unit: 'm²',
        description: 'Demountable office partitions',
        isPro: true,
        residential: false,
        commercial: true
      },
      
      // Pro Materials - External & Roofing
      brick_veneer: {
        color: '#B22222',
        materialCost: 85,
        laborCost: 65,
        wastage: 0.10,
        category: 'external',
        unit: 'm²',
        description: 'Clay brick veneer',
        isPro: true,
        residential: true,
        commercial: true
      },
      colorbond_roofing: {
        color: '#2F4F4F',
        materialCost: 45,
        laborCost: 35,
        wastage: 0.08,
        category: 'roofing',
        unit: 'm²',
        description: 'Colorbond steel roofing',
        isPro: true,
        residential: true,
        commercial: true
      },
      concrete_tile_roof: {
        color: '#8B4513',
        materialCost: 38,
        laborCost: 42,
        wastage: 0.12,
        category: 'roofing',
        unit: 'm²',
        description: 'Concrete roof tiles',
        isPro: true,
        residential: true,
        commercial: false
      },
      membrane_roofing: {
        color: '#2F2F2F',
        materialCost: 65,
        laborCost: 45,
        wastage: 0.08,
        category: 'roofing',
        unit: 'm²',
        description: 'Commercial membrane roofing',
        isPro: true,
        residential: false,
        commercial: true
      },
      render_external: {
        color: '#F5DEB3',
        materialCost: 35,
        laborCost: 55,
        wastage: 0.15,
        category: 'external',
        unit: 'm²',
        description: 'Acrylic render finish',
        isPro: true,
        residential: true,
        commercial: true
      },
      aluminum_cladding: {
        color: '#D3D3D3',
        materialCost: 95,
        laborCost: 55,
        wastage: 0.08,
        category: 'external',
        unit: 'm²',
        description: 'Aluminum composite cladding',
        isPro: true,
        residential: false,
        commercial: true
      },
      
      // Pro Materials - Internal
      plasterboard: {
        color: '#FFFAF0',
        materialCost: 18,
        laborCost: 22,
        wastage: 0.10,
        category: 'internal',
        unit: 'm²',
        description: 'Standard plasterboard',
        isPro: true,
        residential: true,
        commercial: true
      },
      suspended_ceiling: {
        color: '#F8F8FF',
        materialCost: 32,
        laborCost: 28,
        wastage: 0.08,
        category: 'internal',
        unit: 'm²',
        description: 'Suspended acoustic ceiling',
        isPro: true,
        residential: false,
        commercial: true
      },
      
      // Fitouts & Services
      kitchen_fitout: {
        color: '#8B4513',
        materialCost: 8500,
        laborCost: 2200,
        wastage: 0.05,
        category: 'fitout',
        unit: 'each',
        description: 'Standard kitchen fitout',
        isPro: true,
        residential: true,
        commercial: false
      },
      commercial_kitchen: {
        color: '#4682B4',
        materialCost: 25000,
        laborCost: 8500,
        wastage: 0.08,
        category: 'fitout',
        unit: 'each',
        description: 'Commercial kitchen fitout',
        isPro: true,
        residential: false,
        commercial: true
      },
      bathroom_fitout: {
        color: '#4169E1',
        materialCost: 4500,
        laborCost: 1800,
        wastage: 0.08,
        category: 'fitout',
        unit: 'each',
        description: 'Standard bathroom fitout',
        isPro: true,
        residential: true,
        commercial: false
      },
      commercial_bathroom: {
        color: '#6495ED',
        materialCost: 12000,
        laborCost: 4200,
        wastage: 0.10,
        category: 'fitout',
        unit: 'each',
        description: 'Commercial bathroom fitout',
        isPro: true,
        residential: false,
        commercial: true
      }
    };

    // Enterprise BIM Auto-Takeoff capabilities
    const BIM_CAPABILITIES = {
      supported_formats: ['DWG', 'DXF', 'IFC', 'RVT', 'SKP', 'PLN', 'PDF'],
      automated_detection: {
        structural: ['slabs', 'beams', 'columns', 'walls', 'footings', 'stairs'],
        architectural: ['doors', 'windows', 'partitions', 'ceilings', 'floors', 'roofs'],
        mep: ['ductwork', 'piping', 'electrical_conduit', 'fire_systems', 'data_cables'],
        finishes: ['flooring', 'wall_finishes', 'ceiling_finishes', 'external_cladding'],
        landscaping: ['excavation', 'concrete_paths', 'retaining_walls', 'drainage']
      },
      measurement_accuracy: '±2%', // Industry leading accuracy
      processing_speed: '15-45 minutes for typical commercial building',
      ai_classification: true, // AI-powered element classification
      clash_detection: true, // Detect design conflicts
      cost_optimization: true // Suggest cost savings
    };

    const ENTERPRISE_PRICING = {
      setup_fee: 15000, // One-time setup and training
      monthly_subscription: 2999, // Per month
      per_project_fee: 500, // Per automated takeoff
      volume_discounts: {
        tier_1: { min_projects: 10, discount: 0.15 }, // 15% off
        tier_2: { min_projects: 25, discount: 0.25 }, // 25% off
        tier_3: { min_projects: 50, discount: 0.35 }  // 35% off
      },
      support_included: true,
      training_included: true,
      api_access: true
    };

    // Complete Australian Rates Schedule (Based on Professional QS Cost Plans)
    const AUSTRALIAN_RATES_SCHEDULE = {
      // PRELIMINARIES & SITE FACILITIES
      preliminaries: {
        site_facilities: {
          site_foreman_day: { unit: 'wk', rate: 4387.39, description: 'Day Foreman - 6 day week - 12 hours per day' },
          site_foreman_night: { unit: 'wk', rate: 5643.00, description: 'Night Foreman - 6 day week - 12 hours per night' },
          project_management: { unit: 'wk', rate: 1889.00, description: 'Project Management - 2 day allocation/week' },
          admin_staff: { unit: 'wk', rate: 522.50, description: 'Office Based Staff - QS / Admin' },
          site_container: { unit: 'wk', rate: 27.17, description: 'Container weekly hire, maintenance and servicing' },
          site_security: { unit: 'wk', rate: 3511.20, description: 'Night-time Security (84 hours per week)' },
          temporary_fencing: { unit: 'wk', rate: 118.35, description: '2.40m high mesh temporary fencing per week' },
          forklift_hire: { unit: 'wk', rate: 551.76, description: 'Forklift weekly hire' },
          scissor_lift: { unit: 'wk', rate: 225.00, description: 'Scissor Lift weekly hire rate' },
          small_tools: { unit: 'wk', rate: 91.96, description: 'Small Tools Allowance' }
        },
        insurances: {
          bank_guarantee: { unit: 'item', rate: 836.00, description: 'Bank Guarantee' },
          mba_fees: { unit: 'item', rate: 2652.68, description: 'M.B.A Fees' },
          car_insurance: { unit: '%', rate: 0.098, description: 'C.A.R Insurance (% of contract value)' },
          q_leave: { unit: '%', rate: 0.48, description: 'Q Leave (% of contract value)' }
        }
      },
      
      // CLEANING & MAINTENANCE
      cleaning: {
        builders_clean_progressive: { unit: 'item', rate: 800.00, description: 'Progressive cleaning during construction' },
        final_clean_handover: { unit: 'hr', rate: 35.00, description: 'Final Clean prior to Handover' },
        final_clean_opening: { unit: 'hr', rate: 35.00, description: 'Final Clean prior to Opening' }
      },
      
      // ELECTRICAL SERVICES
      electrical: {
        rough_in_residential: { unit: 'm²', rate: 60.00, description: 'Electrical rough-in residential' },
        rough_in_commercial: { unit: 'm²', rate: 85.00, description: 'Electrical rough-in commercial' },
        power_points: { unit: 'no', rate: 180.00, description: 'GPO installation' },
        light_fittings: { unit: 'no', rate: 120.00, description: 'Light fitting installation' },
        switchboard_upgrade: { unit: 'item', rate: 2500.00, description: 'Switchboard upgrade' },
        emergency_lighting: { unit: 'm²', rate: 12.50, description: 'Emergency & exit lighting system' },
        data_cabling: { unit: 'point', rate: 150.00, description: 'Data cabling per point' }
      },
      
      // PLUMBING SERVICES
      plumbing: {
        rough_in_residential: { unit: 'm²', rate: 50.00, description: 'Plumbing rough-in residential' },
        rough_in_commercial: { unit: 'm²', rate: 77.00, description: 'Plumbing rough-in commercial' },
        hand_wash_sink: { unit: 'no', rate: 450.00, description: 'Install hand wash sink' },
        work_sink: { unit: 'no', rate: 450.00, description: 'Install work sink' },
        barista_sink: { unit: 'no', rate: 450.00, description: 'Install barista sink (commercial)' },
        water_tap_14inch: { unit: 'no', rate: 320.00, description: '14" Water tap installation' },
        sprayer_tower: { unit: 'no', rate: 900.00, description: 'Vegetable Tower Sprayer' },
        grease_trap: { unit: 'no', rate: 1200.00, description: 'Commercial grease trap' }
      },
      
      // HVAC SYSTEMS
      hvac: {
        ducted_heating_residential: { unit: 'm²', rate: 85.00, description: 'Ducted heating system (residential)' },
        hydronic_heating: { unit: 'm²', rate: 125.00, description: 'Hydronic heating system' },
        split_system_residential: { unit: 'm²', rate: 45.00, description: 'Split system A/C (residential)' },
        commercial_hvac: { unit: 'm²', rate: 180.00, description: 'Commercial HVAC system' },
        vrf_system: { unit: 'm²', rate: 220.00, description: 'VRF air conditioning system' },
        exhaust_fans: { unit: 'no', rate: 350.00, description: 'Commercial exhaust fan' },
        ductwork_supply: { unit: 'm', rate: 85.00, description: 'Supply ductwork per linear metre' },
        ductwork_return: { unit: 'm', rate: 65.00, description: 'Return ductwork per linear metre' }
      },
      
      // FIRE SERVICES
      fire_services: {
        detection_alarm: { unit: 'm²', rate: 35.00, description: 'Fire detection & alarm system' },
        sprinkler_system: { unit: 'm²', rate: 65.00, description: 'Sprinkler system (commercial)' },
        fire_hose_reel: { unit: 'no', rate: 800.00, description: 'Fire hose reel installation' },
        fire_extinguisher: { unit: 'no', rate: 120.00, description: 'Fire extinguisher supply & install' },
        emergency_lighting: { unit: 'm²', rate: 25.00, description: 'Emergency lighting system' },
        exit_signage: { unit: 'no', rate: 180.00, description: 'Exit signage illuminated' }
      },
      
      // JOINERY & FITOUT
      joinery: {
        kitchen_benchtops: { unit: 'm', rate: 450.00, description: 'Kitchen benchtops (stone)' },
        wall_cabinets: { unit: 'm', rate: 380.00, description: 'Wall mounted cabinets' },
        base_cabinets: { unit: 'm', rate: 420.00, description: 'Base cabinets with doors' },
        commercial_joinery: { unit: 'm²', rate: 650.00, description: 'Commercial joinery fitout' },
        reception_desk: { unit: 'item', rate: 3500.00, description: 'Reception desk (commercial)' },
        retail_shelving: { unit: 'm', rate: 280.00, description: 'Retail shelving system' },
        display_units: { unit: 'no', rate: 1200.00, description: 'Custom display units' }
      },
      
      // TILING & FINISHES
      tiling: {
        wall_tiles_standard: { unit: 'm²', rate: 65.00, description: 'Wall tiles (standard ceramic)' },
        wall_tiles_premium: { unit: 'm²', rate: 95.00, description: 'Wall tiles (premium/designer)' },
        floor_tiles_standard: { unit: 'm²', rate: 55.00, description: 'Floor tiles (standard ceramic)' },
        floor_tiles_premium: { unit: 'm²', rate: 85.00, description: 'Floor tiles (premium/porcelain)' },
        mosaic_tiles: { unit: 'm²', rate: 120.00, description: 'Mosaic tiles (feature)' },
        waterproofing: { unit: 'm²', rate: 45.00, description: 'Waterproofing membrane' }
      },
      
      // LABOUR RATES BY TRADE
      labour_rates: {
        carpenter: { unit: 'hr', rate: 65.00, description: 'Qualified Carpenter' },
        electrician: { unit: 'hr', rate: 85.00, description: 'Licensed Electrician' },
        plumber: { unit: 'hr', rate: 82.00, description: 'Licensed Plumber' },
        tiler: { unit: 'hr', rate: 58.00, description: 'Qualified Tiler' },
        painter: { unit: 'hr', rate: 55.00, description: 'Qualified Painter' },
        labourer: { unit: 'hr', rate: 45.00, description: 'General Labourer' },
        foreman: { unit: 'hr', rate: 75.00, description: 'Site Foreman' },
        crane_operator: { unit: 'hr', rate: 95.00, description: 'Crane Operator' },
        concreter: { unit: 'hr', rate: 68.00, description: 'Qualified Concreter' },
        steel_fixer: { unit: 'hr', rate: 72.00, description: 'Steel Fixer' }
      }
    };

    // Professional QS Report Templates (AIQS Standard)
    const QS_REPORT_TEMPLATES = {
      elemental_cost_plan: {
        name: 'Elemental Cost Plan (AIQS Standard)',
        sections: ['project_overview', 'preliminaries', 'substructure', 'superstructure', 'finishes', 'fittings', 'services', 'external_works', 'contingency', 'gst'],
        format: 'detailed_breakdown'
      },
      trade_breakdown: {
        name: 'Trade Contractor Breakdown',
        sections: ['excavation', 'concrete', 'masonry', 'steel', 'carpentry', 'roofing', 'electrical', 'plumbing', 'hvac', 'finishes', 'preliminaries'],
        format: 'trade_packages'
      },
      workstream_schedule: {
        name: 'Workstream Rates Schedule',
        sections: ['site_facilities', 'labour_rates', 'material_rates', 'plant_equipment', 'subcontractor_rates', 'regional_variations'],
        format: 'comprehensive_rates'
      },
      cost_comparison: {
        name: 'Design Option Cost Comparison',
        sections: ['option_summary', 'detailed_comparison', 'variance_analysis', 'recommendations', 'risk_assessment'],
        format: 'comparative_analysis'
      },
      client_report: {
        name: 'Professional Client Cost Report',
        sections: ['executive_summary', 'cost_breakdown', 'schedule_analysis', 'risk_factors', 'recommendations', 'appendices'],
        format: 'client_presentation'
      }
    };

    // MEP Services costs by project type
    const MEP_SERVICES = {
      residential: {
        electrical_rough_in: {
          description: 'Electrical rough-in (residential)',
          cost: 35,
          unit: 'm²',
          category: 'electrical'
        },
        electrical_fitoff: {
          description: 'Electrical fit-off & testing',
          cost: 25,
          unit: 'm²',
          category: 'electrical'
        },
        plumbing_rough_in: {
          description: 'Plumbing rough-in',
          cost: 28,
          unit: 'm²',
          category: 'plumbing'
        },
        plumbing_fitoff: {
          description: 'Plumbing fit-off & testing',
          cost: 22,
          unit: 'm²',
          category: 'plumbing'
        },
        ducted_heating: {
          description: 'Ducted heating system',
          cost: 85,
          unit: 'm²',
          category: 'hvac'
        },
        hydronic_heating: {
          description: 'Hydronic heating system',
          cost: 125,
          unit: 'm²',
          category: 'hvac'
        },
        split_system_ac: {
          description: 'Split system air conditioning',
          cost: 45,
          unit: 'm²',
          category: 'hvac'
        }
      },
      commercial: {
        electrical_rough_in: {
          description: 'Electrical rough-in (commercial)',
          cost: 55,
          unit: 'm²',
          category: 'electrical'
        },
        electrical_fitoff: {
          description: 'Electrical fit-off & testing',
          cost: 45,
          unit: 'm²',
          category: 'electrical'
        },
        fire_services: {
          description: 'Fire detection & alarm system',
          cost: 35,
          unit: 'm²',
          category: 'fire'
        },
        sprinkler_system: {
          description: 'Fire sprinkler system',
          cost: 65,
          unit: 'm²',
          category: 'fire'
        },
        plumbing_rough_in: {
          description: 'Plumbing rough-in (commercial)',
          cost: 42,
          unit: 'm²',
          category: 'plumbing'
        },
        plumbing_fitoff: {
          description: 'Plumbing fit-off & testing',
          cost: 35,
          unit: 'm²',
          category: 'plumbing'
        },
        hvac_system: {
          description: 'Commercial HVAC system',
          cost: 180,
          unit: 'm²',
          category: 'hvac'
        },
        vrf_system: {
          description: 'VRF air conditioning system',
          cost: 220,
          unit: 'm²',
          category: 'hvac'
        },
        bms_system: {
          description: 'Building management system',
          cost: 25,
          unit: 'm²',
          category: 'electrical'
        },
        data_cabling: {
          description: 'Data & communication cabling',
          cost: 18,
          unit: 'm²',
          category: 'electrical'
        }
      }
    };

    // Site costs and overheads for Pro version
    const SITE_COSTS = {
      mobilization: {
        description: 'Site setup and mobilization',
        cost: 8500,
        unit: 'lump sum'
      },
      scaffolding: {
        description: 'Scaffolding hire',
        cost: 125,
        unit: 'week'
      },
      crane_hire: {
        description: 'Mobile crane hire',
        cost: 1800,
        unit: 'day'
      },
      site_shed: {
        description: 'Site office and amenities',
        cost: 450,
        unit: 'month'
      },
      utilities: {
        description: 'Temporary power and water',
        cost: 850,
        unit: 'month'
      },
      waste_removal: {
        description: 'Waste disposal',
        cost: 380,
        unit: 'skip'
      },
      security: {
        description: 'Site security',
        cost: 320,
        unit: 'week'
      }
    };

    // Labor rates by trade for Pro version
    const LABOR_RATES = {
      general_laborer: { rate: 45, unit: 'hour', description: 'General construction laborer' },
      carpenter: { rate: 65, unit: 'hour', description: 'Qualified carpenter' },
      bricklayer: { rate: 70, unit: 'hour', description: 'Qualified bricklayer' },
      electrician: { rate: 85, unit: 'hour', description: 'Licensed electrician' },
      plumber: { rate: 80, unit: 'hour', description: 'Licensed plumber' },
      painter: { rate: 55, unit: 'hour', description: 'Professional painter' },
      roofer: { rate: 68, unit: 'hour', description: 'Roof specialist' },
      tiler: { rate: 62, unit: 'hour', description: 'Tile specialist' },
      concreter: { rate: 58, unit: 'hour', description: 'Concrete specialist' },
      project_manager: { rate: 95, unit: 'hour', description: 'Project manager/supervisor' }
    };

    // Project overheads and margins
    const PROJECT_OVERHEADS = {
      overhead_percentage: 0.15, // 15% for company overheads
      profit_margin: 0.12, // 12% profit margin
      gst: 0.10, // 10% GST
      contingency: 0.08 // 8% contingency
    };

    // Global variables
    let isPro = false; // Set to true for Pro version
    let isEnterprise = false; // Set to true for Enterprise BIM Auto-Takeoff
    let projectSiteCosts = {}; // Track site costs for current project
    let projectLaborAllocation = {}; // Track labor allocation
    let projectType = 'residential'; // 'residential' or 'commercial'
    let projectServices = {}; // Track MEP services
    let cadProcessingResults = {}; // Store automated takeoff results

    // Templates for common construction elements
    const TEMPLATES = [
      { name: 'Standard Room', shape: 'rectangle', width: 400, height: 300, material: 'carpet' },
      { name: 'Kitchen', shape: 'rectangle', width: 350, height: 250, material: 'tiles' },
      { name: 'Bathroom', shape: 'rectangle', width: 200, height: 150, material: 'tiles' },
      { name: 'Hallway', shape: 'rectangle', width: 120, height: 800, material: 'laminate' },
      { name: 'Living Area', shape: 'rectangle', width: 500, height: 400, material: 'timber' },
      { name: 'Wall Section', shape: 'rectangle', width: 500, height: 20, material: 'timber' },
      { name: 'Door Opening', shape: 'rectangle', width: 90, height: 210, material: 'timber' }
    ];

    // Enhanced CanvasManager Implementation
    class CanvasManager {
      constructor(canvasElement) {
        this.canvas = new fabric.Canvas(canvasElement, {
          width: 800,
          height: 500,
          backgroundColor: "#F9FAFB",
          selection: true,
          enableRetinaScaling: false,
          preserveObjectStacking: true,
          imageSmoothingEnabled: false,
          renderOnAddRemove: false,
        });

        this.rooms = new Map();
        this.selectedMaterial = "timber";
        this.currentShape = "rectangle";
        this.isDrawing = false;
        this.drawingStartPoint = null;
        this.previewShape = null;
        this.polygonPoints = [];
        this.drawingPath = null;
        this.backgroundImage = null;
        this.gridVisible = true;
        this.gridGroup = null;
        this.zoomLevel = 1;
        this.isPanning = false;
        this.panStartPoint = null;
        this.onRoomsChange = null;
        this.scaleFactor = 100; // Default: 100 pixels = 1 meter
        this.isCalibrating = false;
        this.calibrationLine = null;

        this.setupEventListeners();
        this.setupDrawingEvents();
        this.setupZoomAndPan();
        this.createGrid();
        this.canvas.renderAll();
      }

      createGrid() {
        const gridSize = 20;
        const canvasWidth = this.canvas.getWidth();
        const canvasHeight = this.canvas.getHeight();
        const lines = [];

        for (let i = 0; i <= canvasWidth; i += gridSize) {
          lines.push(new fabric.Line([i, 0, i, canvasHeight], {
            stroke: '#E5E7EB',
            strokeWidth: i % (gridSize * 5) === 0 ? 1.5 : 0.5,
            selectable: false,
            evented: false,
          }));
        }

        for (let i = 0; i <= canvasHeight; i += gridSize) {
          lines.push(new fabric.Line([0, i, canvasWidth, i], {
            stroke: '#E5E7EB',
            strokeWidth: i % (gridSize * 5) === 0 ? 1.5 : 0.5,
            selectable: false,
            evented: false,
          }));
        }

        this.gridGroup = new fabric.Group(lines, {
          selectable: false,
          evented: false,
          opacity: 0.7,
        });

        this.canvas.add(this.gridGroup);
        this.gridGroup.visible = this.gridVisible;
        this.canvas.renderAll();
      }

      setupZoomAndPan() {
        this.canvas.on('mouse:wheel', (opt) => {
          const delta = opt.e.deltaY;
          let zoom = this.canvas.getZoom();
          zoom *= 0.999 ** delta;
          
          if (zoom > 20) zoom = 20;
          if (zoom < 0.1) zoom = 0.1;
          
          this.zoomLevel = zoom;
          this.canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
          
          opt.e.preventDefault();
          opt.e.stopPropagation();
        });

        this.canvas.on('mouse:down', (opt) => {
          const evt = opt.e;
          if (evt.button === 1 || (evt.button === 0 && evt.shiftKey)) {
            this.isPanning = true;
            this.canvas.selection = false;
            this.panStartPoint = { x: evt.clientX, y: evt.clientY };
            opt.e.preventDefault();
          }
        });

        this.canvas.on('mouse:move', (opt) => {
          if (this.isPanning && this.panStartPoint) {
            const evt = opt.e;
            const vpt = this.canvas.viewportTransform;
            vpt[4] += evt.clientX - this.panStartPoint.x;
            vpt[5] += evt.clientY - this.panStartPoint.y;
            this.canvas.requestRenderAll();
            this.panStartPoint = { x: evt.clientX, y: evt.clientY };
          }
        });

        this.canvas.on('mouse:up', () => {
          if (this.isPanning) {
            this.isPanning = false;
            this.canvas.selection = true;
            this.panStartPoint = null;
          }
        });
      }

      setupEventListeners() {
        this.canvas.on("object:modified", this.handleObjectModified.bind(this));
        this.canvas.on("mouse:dblclick", this.handleMouseDoubleClick.bind(this));
        this.canvas.selection = true;
        this.canvas.skipTargetFind = false;
      }

      setupDrawingEvents() {
        this.canvas.on("mouse:down", this.handleMouseDown.bind(this));
        this.canvas.on("mouse:move", this.handleMouseMove.bind(this));
        this.canvas.on("mouse:up", this.handleMouseUp.bind(this));
      }

      handleMouseDown(e) {
        if (this.isPanning) return;

        const pointer = this.canvas.getPointer(e.e);

        switch (this.currentShape) {
          case "freehand":
            this.isDrawing = true;
            this.drawingPath = new fabric.Path(`M ${pointer.x} ${pointer.y}`, {
              stroke: MATERIALS[this.selectedMaterial].color,
              strokeWidth: 3,
              fill: "",
              selectable: false,
            });
            this.canvas.add(this.drawingPath);
            break;

          case "rectangle":
            this.drawingStartPoint = pointer;
            this.isDrawing = true;
            this.previewShape = new fabric.Rect({
              left: pointer.x,
              top: pointer.y,
              width: 0,
              height: 0,
              fill: `${MATERIALS[this.selectedMaterial].color}40`,
              stroke: MATERIALS[this.selectedMaterial].color,
              strokeWidth: 2,
              selectable: false,
              evented: false,
            });
            this.canvas.add(this.previewShape);
            break;

          case "circle":
            this.drawingStartPoint = pointer;
            this.isDrawing = true;
            this.previewShape = new fabric.Circle({
              left: pointer.x,
              top: pointer.y,
              radius: 0,
              fill: `${MATERIALS[this.selectedMaterial].color}40`,
              stroke: MATERIALS[this.selectedMaterial].color,
              strokeWidth: 2,
              selectable: false,
              evented: false,
            });
            this.canvas.add(this.previewShape);
            break;

          case "line":
            this.drawingStartPoint = pointer;
            this.isDrawing = true;
            this.previewShape = new fabric.Line([pointer.x, pointer.y, pointer.x, pointer.y], {
              stroke: MATERIALS[this.selectedMaterial].color,
              strokeWidth: 4,
              selectable: false,
              evented: false,
            });
            this.canvas.add(this.previewShape);
            break;

          case "polygon":
            this.polygonPoints.push(pointer);
            if (this.polygonPoints.length === 1) {
              this.isDrawing = true;
            }
            break;
        }
      }

      handleMouseMove(e) {
        const pointer = this.canvas.getPointer(e.e);

        if (this.currentShape === "freehand" && this.isDrawing && this.drawingPath) {
          const path = this.drawingPath.path;
          path.push(["L", pointer.x, pointer.y]);
          this.drawingPath.path = path;
          this.canvas.renderAll();
          return;
        }

        if (!this.isDrawing || !this.drawingStartPoint) return;

        switch (this.currentShape) {
          case "rectangle":
            const width = pointer.x - this.drawingStartPoint.x;
            const height = pointer.y - this.drawingStartPoint.y;
            this.previewShape.set({
              left: width < 0 ? pointer.x : this.drawingStartPoint.x,
              top: height < 0 ? pointer.y : this.drawingStartPoint.y,
              width: Math.abs(width),
              height: Math.abs(height),
            });
            this.canvas.renderAll();
            break;

          case "circle":
            const dx = pointer.x - this.drawingStartPoint.x;
            const dy = pointer.y - this.drawingStartPoint.y;
            const radius = Math.sqrt(dx * dx + dy * dy);
            this.previewShape.set({
              left: this.drawingStartPoint.x - radius,
              top: this.drawingStartPoint.y - radius,
              radius,
            });
            this.canvas.renderAll();
            break;

          case "line":
            this.previewShape.set({
              x2: pointer.x,
              y2: pointer.y,
            });
            this.canvas.renderAll();
            break;
        }
      }

      handleMouseUp(e) {
        if (this.currentShape === "freehand" && this.isDrawing) {
          this.isDrawing = false;
          if (this.drawingPath) {
            this.drawingPath.selectable = true;
            this.convertPathToRoom(this.drawingPath);
            this.drawingPath = null;
          }
          return;
        }

        if (!this.isDrawing || !this.previewShape) return;

        this.previewShape.selectable = true;
        this.previewShape.evented = true;
        const bounds = this.previewShape.getBoundingRect();

        // Handle calibration for lines
        if (this.isCalibrating && this.currentShape === 'line') {
          const line = this.previewShape;
          const lineLength = Math.sqrt(
            Math.pow(line.x2 - line.x1, 2) + Math.pow(line.y2 - line.y1, 2)
          );
          this.calibrationLine = line;
          this.finishCalibration(lineLength);
          return;
        }

        const room = {
          id: Date.now().toString(),
          name: `${this.currentShape.charAt(0).toUpperCase() + this.currentShape.slice(1)} Room`,
          width: bounds.width,
          height: bounds.height,
          material: this.selectedMaterial,
          cost: 0,
          positionX: bounds.left,
          positionY: bounds.top,
          shapeType: this.currentShape,
          fabricObject: this.previewShape,
        };
        room.cost = this.calculateRoomCost(room);
        this.rooms.set(room.id, room);
        this.notifyRoomsChange();

        this.previewShape = null;
        this.drawingStartPoint = null;
        this.isDrawing = false;
        this.canvas.renderAll();
      }

      handleMouseDoubleClick(e) {
        if (this.currentShape !== "polygon" || !this.isDrawing || this.polygonPoints.length < 3) return;

        if (this.previewShape) {
          this.canvas.remove(this.previewShape);
          this.previewShape = null;
        }

        const poly = new fabric.Polygon(this.polygonPoints, {
          fill: `${MATERIALS[this.selectedMaterial].color}40`,
          stroke: MATERIALS[this.selectedMaterial].color,
          strokeWidth: 2,
          selectable: true,
          evented: true,
        });
        this.canvas.add(poly);
        const bounds = poly.getBoundingRect();
        const room = {
          id: Date.now().toString(),
          name: "Polygon Room",
          width: bounds.width,
          height: bounds.height,
          material: this.selectedMaterial,
          cost: 0,
          positionX: bounds.left,
          positionY: bounds.top,
          shapeType: "polygon",
          points: this.polygonPoints.flatMap((p) => [p.x, p.y]),
          fabricObject: poly,
        };
        room.cost = this.calculateRoomCost(room);
        this.rooms.set(room.id, room);
        this.notifyRoomsChange();

        this.polygonPoints = [];
        this.isDrawing = false;
        this.canvas.renderAll();
      }

      convertPathToRoom(path) {
        const bounds = path.getBoundingRect();
        const pathCommands = path.path || [];
        const points = [];
        pathCommands.forEach((cmd) => {
          if (cmd[0] === "M" || cmd[0] === "L") {
            points.push({ x: cmd[1], y: cmd[2] });
          }
        });
        const room = {
          id: Date.now().toString(),
          name: "Freehand Room",
          width: bounds.width,
          height: bounds.height,
          material: this.selectedMaterial,
          cost: 0,
          positionX: bounds.left,
          positionY: bounds.top,
          shapeType: "freehand",
          points: points.flatMap((p) => [p.x, p.y]),
          fabricObject: path,
        };
        room.cost = this.calculateRoomCost(room);
        this.rooms.set(room.id, room);
        this.notifyRoomsChange();
      }

      handleObjectModified(e) {
        const obj = e.target;
        if (!obj) return;

        for (const [id, room] of this.rooms) {
          if (room.fabricObject === obj) {
            const bounds = obj.getBoundingRect();
            room.width = bounds.width;
            room.height = bounds.height;
            room.positionX = bounds.left;
            room.positionY = bounds.top;
            room.cost = this.calculateRoomCost(room);
            this.notifyRoomsChange();
            break;
          }
        }
      }

      calculateRoomCost(room) {
        // Convert canvas pixels to real-world square meters using scale factor
        const areaSquareMeters = (room.width * room.height) / (this.scaleFactor * this.scaleFactor);
        const material = MATERIALS[room.material];
        
        if (isPro && material.materialCost !== undefined) {
          // Pro calculation with detailed breakdown
          const materialCost = material.materialCost * areaSquareMeters;
          const laborCost = material.laborCost * areaSquareMeters;
          const wasteAmount = (materialCost + laborCost) * material.wastage;
          return Math.round(materialCost + laborCost + wasteAmount);
        } else {
          // Basic calculation for free version
          const totalCost = material.materialCost + material.laborCost || material.cost || 0;
          return Math.round(areaSquareMeters * totalCost);
        }
      }

      // Scaling and measurement methods
      setScale(calibrationLengthPixels, realLengthMeters) {
        this.scaleFactor = calibrationLengthPixels / realLengthMeters;
        // Recalculate all room costs
        this.rooms.forEach(room => {
          room.cost = this.calculateRoomCost(room);
        });
        this.notifyRoomsChange();
        updateScaleDisplay();
      }

      startCalibration() {
        this.isCalibrating = true;
        this.currentShape = 'line';
        alert('Draw a line on a known distance, then enter the real-world length in meters.');
      }

      finishCalibration(lineLength) {
        const realLength = prompt('Enter the real-world length of this line in meters:');
        if (realLength && !isNaN(realLength) && realLength > 0) {
          this.setScale(lineLength, parseFloat(realLength));
          alert(`Scale set: ${this.scaleFactor.toFixed(1)} pixels per meter`);
        }
        this.isCalibrating = false;
        this.calibrationLine = null;
      }

      // Template methods
      addTemplate(template) {
        const shape = this.createTemplateShape(template);
        const centerX = this.canvas.getWidth() / 2;
        const centerY = this.canvas.getHeight() / 2;
        
        shape.set({
          left: centerX - template.width / 2,
          top: centerY - template.height / 2,
        });

        this.canvas.add(shape);
        this.canvas.setActiveObject(shape);
        this.canvas.renderAll();

        const bounds = shape.getBoundingRect();
        const room = {
          id: Date.now().toString(),
          name: template.name,
          width: template.width,
          height: template.height,
          material: template.material,
          cost: this.calculateRoomCost({ width: template.width, height: template.height, material: template.material }),
          positionX: bounds.left,
          positionY: bounds.top,
          shapeType: template.shape,
          fabricObject: shape,
        };

        this.rooms.set(room.id, room);
        this.notifyRoomsChange();
        return room;
      }

      createTemplateShape(template) {
        const baseStyle = {
          fill: `${MATERIALS[template.material].color}40`,
          stroke: MATERIALS[template.material].color,
          strokeWidth: 2,
          selectable: true,
          evented: true,
        };

        switch (template.shape) {
          case "rectangle":
            return new fabric.Rect({ ...baseStyle, width: template.width, height: template.height });
          case "circle":
            return new fabric.Circle({ ...baseStyle, radius: template.width / 2 });
          default:
            return new fabric.Rect({ ...baseStyle, width: template.width, height: template.height });
        }
      }

      // Custom material methods
      addCustomMaterial(name, color, cost) {
        MATERIALS[name.toLowerCase()] = { color, cost };
        this.updateMaterialSelect();
      }

      updateMaterialSelect() {
        const select = document.getElementById('material-select');
        select.innerHTML = '';
        Object.keys(MATERIALS).forEach(key => {
          const opt = document.createElement('option');
          opt.value = key;
          const icon = this.getMaterialIcon(key);
          opt.textContent = `${icon} ${key.charAt(0).toUpperCase() + key.slice(1)} ($${MATERIALS[key].cost}/m²)`;
          select.appendChild(opt);
        });
      }

      getMaterialIcon(material) {
        const icons = {
          timber: '🌳', carpet: '🪑', tiles: '🏺', laminate: '📋', vinyl: '💿',
          concrete: '🧱', steel: '⚙️', stone: '🪨', glass: '🔷'
        };
        return icons[material] || '📐';
      }

      // Public methods
      setCurrentShape(shape) {
        this.currentShape = shape;
        document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(shape + '-btn').classList.add('active');
      }

      setSelectedMaterial(material) {
        this.selectedMaterial = material;
      }

      addRoom() {
        const centerX = this.canvas.getWidth() / 2;
        const centerY = this.canvas.getHeight() / 2;
        
        const shape = this.createShape();
        shape.set({
          left: centerX - 50,
          top: centerY - 40,
        });

        this.canvas.add(shape);
        this.canvas.setActiveObject(shape);
        this.canvas.renderAll();

        const bounds = shape.getBoundingRect();
        const room = {
          id: Date.now().toString(),
          name: "New Room",
          width: bounds.width,
          height: bounds.height,
          material: this.selectedMaterial,
          cost: this.calculateRoomCost({ width: bounds.width, height: bounds.height, material: this.selectedMaterial }),
          positionX: centerX - 50,
          positionY: centerY - 40,
          shapeType: this.currentShape,
          fabricObject: shape,
        };

        this.rooms.set(room.id, room);
        this.notifyRoomsChange();
        return room;
      }

      createShape() {
        const baseStyle = {
          fill: `${MATERIALS[this.selectedMaterial].color}40`,
          stroke: MATERIALS[this.selectedMaterial].color,
          strokeWidth: 2,
          selectable: true,
          evented: true,
        };

        switch (this.currentShape) {
          case "rectangle":
            return new fabric.Rect({ ...baseStyle, width: 100, height: 80 });
          case "circle":
            return new fabric.Circle({ ...baseStyle, radius: 50 });
          case "polygon":
            const points = [
              { x: 50, y: 0 }, { x: 100, y: 25 }, { x: 75, y: 75 }, { x: 25, y: 75 }, { x: 0, y: 25 }
            ];
            return new fabric.Polygon(points, baseStyle);
          case "line":
            return new fabric.Line([0, 0, 100, 100], { ...baseStyle, strokeWidth: 4 });
          default:
            return new fabric.Rect({ ...baseStyle, width: 100, height: 80 });
        }
      }

      clearCanvas() {
        this.canvas.clear();
        this.rooms.clear();
        this.backgroundImage = null;
        this.createGrid();
        this.canvas.renderAll();
        this.notifyRoomsChange();
      }

      toggleGrid() {
        this.gridVisible = !this.gridVisible;
        if (this.gridGroup) {
          this.gridGroup.visible = this.gridVisible;
          this.canvas.renderAll();
        }
      }

      zoomIn() {
        const zoom = Math.min(this.zoomLevel * 1.2, 20);
        this.canvas.setZoom(zoom);
        this.zoomLevel = zoom;
      }

      zoomOut() {
        const zoom = Math.max(this.zoomLevel * 0.8, 0.1);
        this.canvas.setZoom(zoom);
        this.zoomLevel = zoom;
      }

      zoomToFit() {
        this.canvas.setZoom(1);
        this.canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
        this.zoomLevel = 1;
      }

      async loadBackgroundImage(file) {
        try {
          const dataUrl = await this.fileToDataUrl(file);
          await this.loadImageFromDataUrl(dataUrl, file.name);
        } catch (error) {
          // Create visual placeholder for unsupported formats
          this.createVisualBackgroundLayer(file);
        }
      }

      fileToDataUrl(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      loadImageFromDataUrl(dataUrl, filename) {
        return new Promise((resolve, reject) => {
          const imgElement = new Image();
          imgElement.onload = () => {
            const canvasWidth = this.canvas.getWidth();
            const canvasHeight = this.canvas.getHeight();
            
            const scaleX = canvasWidth / imgElement.width;
            const scaleY = canvasHeight / imgElement.height;
            const scale = Math.min(scaleX, scaleY);
            
            const img = new fabric.Image(imgElement, {
              left: 0,
              top: 0,
              selectable: false,
              evented: false,
              opacity: 0.7,
              scaleX: scale,
              scaleY: scale,
            });
            
            if (this.backgroundImage) {
              this.canvas.remove(this.backgroundImage);
            }
            
            this.backgroundImage = img;
            this.canvas.add(img);
            this.canvas.sendToBack(img);
            this.canvas.renderAll();
            resolve();
          };
          imgElement.onerror = () => reject(new Error(`Failed to load: ${filename}`));
          imgElement.src = dataUrl;
        });
      }

      createVisualBackgroundLayer(file) {
        if (this.backgroundImage) {
          this.canvas.remove(this.backgroundImage);
        }
        
        const canvasWidth = this.canvas.getWidth();
        const canvasHeight = this.canvas.getHeight();
        
        const backgroundRect = new fabric.Rect({
          left: 0,
          top: 0,
          width: canvasWidth,
          height: canvasHeight,
          fill: '#fafafa',
          stroke: '#9ca3af',
          strokeWidth: 2,
          selectable: false,
          evented: false,
          opacity: 0.9,
        });
        
        const text = new fabric.Text(`Background: ${file.name}\n(Visual placeholder)`, {
          left: canvasWidth / 2,
          top: canvasHeight / 2,
          fontSize: 16,
          fill: '#6b7280',
          textAlign: 'center',
          selectable: false,
          evented: false,
          originX: 'center',
          originY: 'center',
        });
        
        this.backgroundImage = new fabric.Group([backgroundRect, text], {
          selectable: false,
          evented: false,
        });
        
        this.canvas.add(this.backgroundImage);
        this.canvas.sendToBack(this.backgroundImage);
        
        if (this.gridGroup) {
          this.gridGroup.visible = false;
        }
        
        this.canvas.renderAll();
      }

      removeBackgroundImage() {
        if (this.backgroundImage) {
          this.canvas.remove(this.backgroundImage);
          this.backgroundImage = null;
          this.canvas.renderAll();
          if (this.gridGroup) {
            this.gridGroup.visible = this.gridVisible;
          }
        }
      }

      setBackgroundOpacity(opacity) {
        if (this.backgroundImage) {
          this.backgroundImage.set('opacity', opacity);
          this.canvas.renderAll();
        }
      }

      deleteRoom(roomId) {
        const room = this.rooms.get(roomId);
        if (room && room.fabricObject) {
          this.canvas.remove(room.fabricObject);
          this.rooms.delete(roomId);
          this.canvas.renderAll();
          this.notifyRoomsChange();
        }
      }

      updateRoomMaterial(roomId, material) {
        const room = this.rooms.get(roomId);
        if (room) {
          room.material = material;
          room.cost = this.calculateRoomCost(room);
          
          if (room.fabricObject) {
            room.fabricObject.set({
              fill: `${MATERIALS[material].color}40`,
              stroke: MATERIALS[material].color,
            });
            this.canvas.renderAll();
          }
          
          this.notifyRoomsChange();
        }
      }

      updateRoomName(roomId, name) {
        const room = this.rooms.get(roomId);
        if (room) {
          room.name = name;
          this.notifyRoomsChange();
        }
      }

      getRooms() {
        return Array.from(this.rooms.values());
      }

      getTotalCost() {
        return Array.from(this.rooms.values()).reduce((total, room) => total + room.cost, 0);
      }

      onRoomsChangeCallback(callback) {
        this.onRoomsChange = callback;
      }

      notifyRoomsChange() {
        if (this.onRoomsChange) {
          this.onRoomsChange(this.getRooms());
        }
      }
    }

    // Global variables
    let canvasManager;

    // Initialize the application
    function init() {
      const canvasElement = document.getElementById('canvas');
      canvasManager = new CanvasManager(canvasElement);
      canvasManager.onRoomsChangeCallback(updateUI);
      
      // Set default active tool
      document.getElementById('rect-btn').classList.add('active');
      
      // Populate templates dropdown
      const templateSelect = document.getElementById('template-select');
      TEMPLATES.forEach(template => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify(template);
        opt.textContent = `${template.name} (${template.width}×${template.height})`;
        templateSelect.appendChild(opt);
      });
      
      // Update scale display
      updateScaleDisplay();
    }

    function updateScaleDisplay() {
      const scaleDisplay = document.getElementById('scale-display');
      if (scaleDisplay) {
        scaleDisplay.textContent = `${canvasManager.scaleFactor.toFixed(1)} pixels = 1m`;
      }
    }

    function updateUI(rooms) {
      const list = document.getElementById('rooms-list');
      list.innerHTML = '';
      
      if (rooms.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No elements yet. Draw on canvas or click "Add Element"</p>';
      } else {
        rooms.forEach(room => {
          const div = document.createElement('div');
          div.className = 'border border-gray-200 p-3 mb-2 rounded-lg bg-gray-50';
          div.innerHTML = `
            <input type="text" value="${room.name}" onchange="updateName('${room.id}', this.value)" class="w-full mb-2 p-1 border rounded text-sm">
            <div class="text-xs text-gray-600 mb-2">
              <p>Size: ${Math.round(room.width)} × ${Math.round(room.height)} units</p>
              <p>Real: ${Math.round(room.width/canvasManager.scaleFactor*10)/10} × ${Math.round(room.height/canvasManager.scaleFactor*10)/10} m</p>
              <p>Area: ${Math.round((room.width * room.height) / (canvasManager.scaleFactor * canvasManager.scaleFactor) * 100) / 100} m²</p>
            </div>
            <select onchange="updateMaterial('${room.id}', this.value)" class="w-full mb-2 p-1 border rounded text-sm">
              ${Object.keys(MATERIALS).map(k => `<option value="${k}" ${k === room.material ? 'selected' : ''}>${k.charAt(0).toUpperCase() + k.slice(1)}</option>`).join('')}
            </select>
            <div class="flex justify-between items-center">
              <span class="font-semibold text-green-600">$${room.cost}</span>
              <button onclick="deleteRoom('${room.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
            </div>
          `;
          list.appendChild(div);
        });
      }

      document.getElementById('total-cost').textContent = `$${canvasManager.getTotalCost()} AUD`;
    }

    // UI Functions
    window.setShape = (shape) => canvasManager.setCurrentShape(shape);
    window.setMaterial = (mat) => canvasManager.setSelectedMaterial(mat);
    window.addElement = () => canvasManager.addRoom();
    window.clearCanvas = () => canvasManager.clearCanvas();
    window.toggleGrid = () => canvasManager.toggleGrid();
    window.zoomIn = () => canvasManager.zoomIn();
    window.zoomOut = () => canvasManager.zoomOut();
    window.zoomToFit = () => canvasManager.zoomToFit();
    window.loadBackground = () => {
      const file = document.getElementById('bg-file').files[0];
      if (file) canvasManager.loadBackgroundImage(file);
    };
    window.removeBackground = () => canvasManager.removeBackgroundImage();
    window.setBgOpacity = (val) => canvasManager.setBackgroundOpacity(parseFloat(val));
    window.deleteRoom = (id) => canvasManager.deleteRoom(id);
    window.updateMaterial = (id, mat) => canvasManager.updateRoomMaterial(id, mat);
    window.updateName = (id, name) => canvasManager.updateRoomName(id, name);

    // New enhanced functions
    window.startCalibration = () => canvasManager.startCalibration();
    
    window.addTemplate = () => {
      const templateSelect = document.getElementById('template-select');
      const selectedValue = templateSelect.value;
      if (selectedValue) {
        const template = JSON.parse(selectedValue);
        canvasManager.addTemplate(template);
        templateSelect.value = ''; // Reset selection
      } else {
        alert('Please select a template first.');
      }
    };

    window.addCustomMaterial = () => {
      const name = document.getElementById('custom-mat-name').value.trim();
      const color = document.getElementById('custom-mat-color').value;
      const cost = parseFloat(document.getElementById('custom-mat-cost').value);
      
      if (!name) {
        alert('Please enter a material name.');
        return;
      }
      if (isNaN(cost) || cost <= 0) {
        alert('Please enter a valid cost.');
        return;
      }
      
      canvasManager.addCustomMaterial(name, color, cost);
      
      // Clear form
      document.getElementById('custom-mat-name').value = '';
      document.getElementById('custom-mat-cost').value = '';
      
      alert(`Material "${name}" added successfully!`);
    };

    // Export Functions
    window.exportToCSV = () => {
      const rooms = canvasManager.getRooms();
      const csv = ['Name,Width (units),Height (units),Width (m),Height (m),Area (m²),Material,Cost (AUD)'];
      rooms.forEach(r => {
        const widthM = Math.round(r.width / canvasManager.scaleFactor * 10) / 10;
        const heightM = Math.round(r.height / canvasManager.scaleFactor * 10) / 10;
        const area = Math.round((r.width * r.height) / (canvasManager.scaleFactor * canvasManager.scaleFactor) * 100) / 100;
        csv.push(`"${r.name}",${r.width},${r.height},${widthM},${heightM},${area},${r.material},${r.cost}`);
      });
      csv.push(`,,,,,,Total,${canvasManager.getTotalCost()}`);
      csv.push(`,,,,,,Scale,"${canvasManager.scaleFactor.toFixed(1)} px/m"`);
      
      const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'construction_takeoff.csv';
      a.click();
      URL.revokeObjectURL(url);
    };

    window.exportToPDF = () => {
      alert('Premium Feature: PDF export includes detailed reports, measurements, and professional formatting. Upgrade to Pro to unlock this feature!');
    };

    window.saveProject = () => {
      const data = {
        rooms: canvasManager.getRooms().map(r => ({
          ...r,
          fabricObject: undefined,
          points: r.points,
        })),
        timestamp: new Date().toISOString(),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `buildcost_project_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    };

    window.loadProject = () => {
      const file = document.getElementById('load-file').files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          canvasManager.clearCanvas();
          
          data.rooms.forEach(r => {
            let obj;
            const base = {
              left: r.positionX,
              top: r.positionY,
              fill: `${MATERIALS[r.material].color}40`,
              stroke: MATERIALS[r.material].color,
              strokeWidth: r.shapeType === 'line' ? 4 : 2,
              selectable: true,
              evented: true,
            };
            
            switch (r.shapeType) {
              case 'rectangle':
                obj = new fabric.Rect({ ...base, width: r.width, height: r.height });
                break;
              case 'circle':
                obj = new fabric.Circle({ ...base, radius: r.width / 2 });
                break;
              case 'polygon':
                const points = [];
                for (let i = 0; i < r.points.length; i += 2) {
                  points.push({ x: r.points[i], y: r.points[i+1] });
                }
                obj = new fabric.Polygon(points, base);
                break;
              case 'line':
                obj = new fabric.Line([0, 0, r.width, r.height], base);
                break;
              case 'freehand':
                let pathStr = 'M ' + r.points[0] + ' ' + r.points[1];
                for (let i = 2; i < r.points.length; i += 2) {
                  pathStr += ' L ' + r.points[i] + ' ' + r.points[i+1];
                }
                obj = new fabric.Path(pathStr, { ...base, fill: '' });
                break;
            }
            
            if (obj) {
              canvasManager.canvas.add(obj);
              r.fabricObject = obj;
              canvasManager.rooms.set(r.id, r);
            }
          });
          
          canvasManager.notifyRoomsChange();
          alert('Project loaded successfully!');
        } catch (error) {
          alert('Error loading project file. Please check the file format.');
        }
      };
      reader.readAsText(file);
    };

    // Marketing Functions
    window.shareProject = () => {
      const url = window.location.href + '?shared=true';
      navigator.clipboard.writeText(url).then(() => {
        alert('Share link copied to clipboard! Note: Actual sharing requires server implementation.');
      }).catch(() => {
        alert('Share link: ' + url + '\n\nCopy this link to share your project!');
      });
    };

    window.subscribe = () => {
      const subscriptionOptions = `EstiMate Subscription Options:

📊 PRO EDITION - $39.99/month
• Complete Australian material library (200+ items)
• Residential vs Commercial project modes  
• Full built form: structure, walls, roofing
• MEP services: electrical, plumbing, HVAC, fire
• Complete labor cost breakdown by trade
• Site mobilization & running costs
• Professional QS reports with GST

🤖 ENTERPRISE BIM AUTO-TAKEOFF - $2,999/month
• Replace entire QS department
• Automated CAD/BIM file processing
• AI-powered element detection (±2% accuracy)
• 15-45 minute complete takeoffs
• AIQS standard elemental cost plans
• Clash detection & design optimization
• Procurement-ready BOM schedules
• Full API integration
• Dedicated support & training
• $15,000 setup fee (includes implementation)

Volume discounts available for Enterprise tier.
Contact us for demo and pricing.`;
      
      alert(subscriptionOptions);
    };

    // Pro functionality for detailed cost breakdown
    function updateTotalCost() {
      const total = canvasManager.getTotalCost();
      document.getElementById('total-cost').textContent = `$${total.toLocaleString()} AUD`;
      
      if (isPro) {
        updateDetailedCostBreakdown();
      }
    }

    function updateDetailedCostBreakdown() {
      const rooms = canvasManager.getRooms();
      let totalMaterialCost = 0;
      let totalLaborCost = 0;
      let totalWastageCost = 0;

      rooms.forEach(room => {
        const material = MATERIALS[room.material];
        if (material && material.materialCost !== undefined) {
          const area = (room.width * room.height) / (canvasManager.scaleFactor * canvasManager.scaleFactor);
          const materialCost = material.materialCost * area;
          const laborCost = material.laborCost * area;
          const wastage = (materialCost + laborCost) * material.wastage;
          
          totalMaterialCost += materialCost;
          totalLaborCost += laborCost;
          totalWastageCost += wastage;
        }
      });

      // Add MEP services costs
      let totalServicesCost = 0;
      Object.values(projectServices).forEach(service => {
        if (service.enabled) {
          totalServicesCost += service.cost || 0;
        }
      });

      // Add site costs
      let totalSiteCosts = 0;
      Object.values(projectSiteCosts).forEach(siteCost => {
        totalSiteCosts += siteCost.cost || 0;
      });

      const constructionSubtotal = totalMaterialCost + totalLaborCost + totalWastageCost;
      const subtotal = constructionSubtotal + totalServicesCost + totalSiteCosts;
      const overheads = subtotal * PROJECT_OVERHEADS.overhead_percentage;
      const profit = subtotal * PROJECT_OVERHEADS.profit_margin;
      const contingency = subtotal * PROJECT_OVERHEADS.contingency;
      const exGst = subtotal + overheads + profit + contingency;
      const gst = exGst * PROJECT_OVERHEADS.gst;
      const totalIncGst = exGst + gst;

      // Update display elements if they exist
      const elements = {
        'cost-materials': Math.round(totalMaterialCost),
        'cost-labor': Math.round(totalLaborCost),
        'cost-wastage': Math.round(totalWastageCost),
        'cost-subtotal': Math.round(subtotal),
        'cost-overheads': Math.round(overheads),
        'cost-profit': Math.round(profit),
        'cost-contingency': Math.round(contingency),
        'cost-ex-gst': Math.round(exGst),
        'cost-gst': Math.round(gst),
        'cost-total-inc-gst': Math.round(totalIncGst)
      };

      Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = `$${value.toLocaleString()}`;
        }
      });
      
      // Add services cost line if there are services
      if (totalServicesCost > 0) {
        const servicesElement = document.getElementById('cost-services');
        if (servicesElement) {
          servicesElement.textContent = `$${Math.round(totalServicesCost).toLocaleString()}`;
        }
      }
    }

    function filterMaterialsByCategory(category) {
      const select = document.getElementById('material-select');
      const optgroups = select.querySelectorAll('optgroup');
      
      optgroups.forEach(optgroup => {
        if (category === 'all') {
          optgroup.style.display = 'block';
        } else {
          const label = optgroup.label.toLowerCase();
          if (label.includes(category)) {
            optgroup.style.display = 'block';
          } else {
            optgroup.style.display = 'none';
          }
        }
      });
    }

    function updateMaterialDetails(materialKey) {
      const material = MATERIALS[materialKey];
      if (material && material.materialCost !== undefined) {
        const elements = {
          'mat-material-cost': `$${material.materialCost}`,
          'mat-labor-cost': `$${material.laborCost}`,
          'mat-wastage': `${(material.wastage * 100).toFixed(1)}%`,
          'mat-total-cost': `$${((material.materialCost + material.laborCost) * (1 + material.wastage)).toFixed(0)}/${material.unit}`
        };
        
        Object.entries(elements).forEach(([id, text]) => {
          const element = document.getElementById(id);
          if (element) element.textContent = text;
        });
      }
    }

    function showSiteCostsModal() {
      if (!isPro) {
        alert('Site cost management is available in EstiMate Pro. Upgrade to access professional quantity surveyor features.');
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
          <h3 class="text-lg font-semibold mb-4">Site Costs & Mobilization</h3>
          <div class="space-y-4">
            ${Object.entries(SITE_COSTS).map(([key, cost]) => `
              <div class="flex justify-between items-center p-3 border rounded-lg">
                <div>
                  <div class="font-medium">${cost.description}</div>
                  <div class="text-sm text-gray-600">$${cost.cost}/${cost.unit}</div>
                </div>
                <div class="flex items-center gap-2">
                  <input type="number" value="0" min="0" id="site-${key}" class="w-20 p-2 border rounded text-center">
                  <span class="text-sm">${cost.unit}</span>
                </div>
              </div>
            `).join('')}
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="applySiteCosts()" class="bg-blue-500 text-white px-4 py-2 rounded flex-1">Apply Site Costs</button>
            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function showLaborRatesModal() {
      if (!isPro) {
        alert('Labor rate management is available in EstiMate Pro. Upgrade to access professional quantity surveyor features.');
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
          <h3 class="text-lg font-semibold mb-4">Australian Labor Rates by Trade</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${Object.entries(LABOR_RATES).map(([key, labor]) => `
              <div class="p-3 border rounded-lg">
                <div class="font-medium">${labor.description}</div>
                <div class="text-sm text-gray-600 mb-2">$${labor.rate}/${labor.unit}</div>
                <input type="number" value="${labor.rate}" min="0" id="labor-${key}" class="w-full p-2 border rounded" placeholder="Rate per ${labor.unit}">
              </div>
            `).join('')}
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="updateLaborRates()" class="bg-blue-500 text-white px-4 py-2 rounded flex-1">Update Rates</button>
            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function applySiteCosts() {
      let totalSiteCosts = 0;
      Object.keys(SITE_COSTS).forEach(key => {
        const input = document.getElementById(`site-${key}`);
        const quantity = parseFloat(input.value) || 0;
        const cost = SITE_COSTS[key].cost * quantity;
        projectSiteCosts[key] = { quantity, cost };
        totalSiteCosts += cost;
      });
      
      const siteCostsList = document.getElementById('site-costs-list');
      if (siteCostsList) {
        siteCostsList.innerHTML = Object.entries(projectSiteCosts)
          .filter(([key, data]) => data.quantity > 0)
          .map(([key, data]) => `
            <div class="flex justify-between text-sm">
              <span>${SITE_COSTS[key].description}</span>
              <span>$${data.cost.toLocaleString()}</span>
            </div>
          `).join('') || '<div class="text-sm text-gray-500">No site costs added</div>';
      }
      
      document.querySelector('.fixed').remove();
      updateTotalCost();
    }

    function updateLaborRates() {
      Object.keys(LABOR_RATES).forEach(key => {
        const input = document.getElementById(`labor-${key}`);
        const newRate = parseFloat(input.value) || LABOR_RATES[key].rate;
        LABOR_RATES[key].rate = newRate;
      });
      
      document.querySelector('.fixed').remove();
      updateTotalCost();
    }

    // Project type management
    function setProjectType(type) {
      projectType = type;
      updateMaterialSelect();
      updateServicesDisplay();
      updateTotalCost();
    }

    function updateMaterialSelect() {
      const select = document.getElementById('material-select');
      select.innerHTML = '';
      
      // Group materials by category
      const categories = {};
      Object.entries(MATERIALS).forEach(([key, material]) => {
        // Check if material is available for current project type
        if (!material.isPro || (material.residential && projectType === 'residential') || (material.commercial && projectType === 'commercial') || (!material.hasOwnProperty('residential') && !material.hasOwnProperty('commercial'))) {
          if (!categories[material.category]) {
            categories[material.category] = [];
          }
          categories[material.category].push({ key, material });
        }
      });
      
      // Create optgroups
      Object.entries(categories).forEach(([category, materials]) => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = category.charAt(0).toUpperCase() + category.slice(1) + (materials[0].material.isPro ? ' (Pro)' : '');
        
        materials.forEach(({ key, material }) => {
          const option = document.createElement('option');
          option.value = key;
          const totalCost = (material.materialCost || 0) + (material.laborCost || 0) || material.cost || 0;
          option.textContent = `${material.description || key} ($${totalCost}/${material.unit || 'm²'})`;
          optgroup.appendChild(option);
        });
        
        select.appendChild(optgroup);
      });
    }

    function updateServicesDisplay() {
      const servicesList = document.getElementById('services-list');
      if (!servicesList) return;
      
      const services = MEP_SERVICES[projectType] || {};
      servicesList.innerHTML = Object.entries(projectServices)
        .filter(([key, data]) => data.enabled && services[key])
        .map(([key, data]) => `
          <div class="flex justify-between text-sm">
            <span>${services[key].description}</span>
            <span>$${(data.cost || 0).toLocaleString()}</span>
          </div>
        `).join('') || '<div class="text-sm text-gray-500">No services configured</div>';
    }

    function updateServicesCosts() {
      const area = parseFloat(document.getElementById('building-area')?.value) || 0;
      const services = MEP_SERVICES[projectType] || {};
      
      Object.keys(projectServices).forEach(serviceKey => {
        if (projectServices[serviceKey].enabled && services[serviceKey]) {
          projectServices[serviceKey].cost = area * services[serviceKey].cost;
        }
      });
      
      updateServicesDisplay();
      updateTotalCost();
    }

    function showServicesModal() {
      if (!isPro) {
        alert('MEP services configuration is available in EstiMate Pro. Upgrade to access professional quantity surveyor features.');
        return;
      }
      
      const services = MEP_SERVICES[projectType] || {};
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full max-h-[80vh] overflow-y-auto">
          <h3 class="text-lg font-semibold mb-4">${projectType.charAt(0).toUpperCase() + projectType.slice(1)} MEP Services</h3>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Total Building Area (m²)</label>
            <input type="number" id="modal-building-area" value="${document.getElementById('building-area')?.value || ''}" class="w-full p-2 border rounded" placeholder="Enter total area">
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            ${Object.entries(services).map(([key, service]) => `
              <div class="p-3 border rounded-lg">
                <div class="flex items-center mb-2">
                  <input type="checkbox" id="service-${key}" ${projectServices[key]?.enabled ? 'checked' : ''} class="mr-2">
                  <label for="service-${key}" class="font-medium">${service.description}</label>
                </div>
                <div class="text-sm text-gray-600">$${service.cost}/${service.unit}</div>
                <div class="text-xs text-gray-500 mt-1">Category: ${service.category}</div>
              </div>
            `).join('')}
          </div>
          
          <div class="flex gap-3">
            <button onclick="applyServicesConfig()" class="bg-blue-500 text-white px-4 py-2 rounded flex-1">Apply Configuration</button>
            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function applyServicesConfig() {
      const area = parseFloat(document.getElementById('modal-building-area')?.value) || 0;
      const services = MEP_SERVICES[projectType] || {};
      
      // Update building area
      const buildingAreaInput = document.getElementById('building-area');
      if (buildingAreaInput) buildingAreaInput.value = area;
      
      // Update service configurations
      Object.keys(services).forEach(serviceKey => {
        const checkbox = document.getElementById(`service-${serviceKey}`);
        if (checkbox) {
          projectServices[serviceKey] = {
            enabled: checkbox.checked,
            cost: checkbox.checked ? area * services[serviceKey].cost : 0
          };
        }
      });
      
      updateServicesDisplay();
      updateTotalCost();
      document.querySelector('.fixed').remove();
    }

    // Override material selection to show details
    window.setMaterial = (material) => {
      canvasManager.setSelectedMaterial(material);
      updateMaterialDetails(material);
    };

    // Enterprise BIM Auto-Takeoff Functions
    function processCadFiles(files) {
      if (!isEnterprise) {
        alert('BIM Auto-Takeoff is available in EstiMate Enterprise Edition.\n\nFeatures:\n• Automated CAD/BIM processing\n• AI-powered takeoff generation\n• Replace QS department\n• ±2% accuracy guarantee\n\nContact us for Enterprise demo: $15k setup + $2,999/month');
        return;
      }
      
      if (files.length === 0) return;
      
      const statusDiv = document.getElementById('processing-status');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      const resultsDiv = document.getElementById('takeoff-results');
      
      statusDiv.style.display = 'block';
      resultsDiv.innerHTML = '';
      
      // Simulate AI processing stages
      const processingStages = [
        { progress: 10, text: 'Analyzing file format and structure...' },
        { progress: 25, text: 'AI element detection in progress...' },
        { progress: 45, text: 'Classifying structural elements...' },
        { progress: 65, text: 'Measuring architectural components...' },
        { progress: 80, text: 'Calculating MEP services quantities...' },
        { progress: 95, text: 'Generating cost breakdown...' },
        { progress: 100, text: 'Auto-takeoff complete!' }
      ];
      
      let currentStage = 0;
      const processInterval = setInterval(() => {
        if (currentStage < processingStages.length) {
          const stage = processingStages[currentStage];
          progressBar.style.width = stage.progress + '%';
          progressText.textContent = stage.text;
          currentStage++;
        } else {
          clearInterval(processInterval);
          setTimeout(() => {
            statusDiv.style.display = 'none';
            displayTakeoffResults();
          }, 1000);
        }
      }, 2000);
    }

    function displayTakeoffResults() {
      const resultsDiv = document.getElementById('takeoff-results');
      
      // Simulate comprehensive takeoff results
      const mockResults = {
        total_area: 2450,
        levels: 3,
        elements_detected: 2847,
        estimated_cost: 3250000,
        categories: {
          substructure: { quantity: 485, unit: 'm²', cost: 145000 },
          superstructure: { quantity: 2450, unit: 'm²', cost: 980000 },
          external_walls: { quantity: 890, unit: 'm²', cost: 320000 },
          roofing: { quantity: 850, unit: 'm²', cost: 185000 },
          internal_partitions: { quantity: 1240, unit: 'm²', cost: 280000 },
          finishes: { quantity: 7350, unit: 'm²', cost: 420000 },
          mep_services: { quantity: 2450, unit: 'm²', cost: 650000 },
          external_works: { quantity: 1, unit: 'lump sum', cost: 270000 }
        }
      };
      
      cadProcessingResults = mockResults;
      
      resultsDiv.innerHTML = `
        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
          <div class="text-sm font-semibold text-green-800 mb-2">🎯 Auto-Takeoff Complete</div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div>Total Area: ${mockResults.total_area.toLocaleString()} m²</div>
            <div>Elements: ${mockResults.elements_detected.toLocaleString()}</div>
            <div>Levels: ${mockResults.levels}</div>
            <div>Accuracy: ±2%</div>
          </div>
          <div class="mt-2 p-2 bg-green-100 rounded text-xs font-semibold text-green-800">
            Estimated Cost: $${mockResults.estimated_cost.toLocaleString()} AUD
          </div>
        </div>
        
        <div class="space-y-1">
          ${Object.entries(mockResults.categories).map(([category, data]) => `
            <div class="flex justify-between text-xs bg-gray-50 p-2 rounded">
              <span class="font-medium">${category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
              <span>$${data.cost.toLocaleString()}</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    function showBimCapabilities() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[80vh] overflow-y-auto">
          <h3 class="text-lg font-semibold mb-4">🤖 Enterprise BIM Auto-Takeoff Capabilities</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="font-semibold mb-3 text-amber-800">Supported File Formats</h4>
              <div class="space-y-2">
                ${BIM_CAPABILITIES.supported_formats.map(format => `
                  <div class="flex items-center p-2 bg-amber-50 rounded">
                    <span class="font-mono text-sm">.${format.toLowerCase()}</span>
                    <span class="ml-2 text-xs text-gray-600">${getFormatDescription(format)}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div>
              <h4 class="font-semibold mb-3 text-blue-800">AI Detection Categories</h4>
              <div class="space-y-3">
                ${Object.entries(BIM_CAPABILITIES.automated_detection).map(([category, elements]) => `
                  <div>
                    <div class="font-medium text-sm capitalize">${category.replace('_', ' ')}</div>
                    <div class="text-xs text-gray-600 ml-2">${elements.join(', ')}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          
          <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-green-50 p-3 rounded-lg">
              <div class="font-semibold text-green-800">Accuracy</div>
              <div class="text-2xl font-bold text-green-700">${BIM_CAPABILITIES.measurement_accuracy}</div>
              <div class="text-xs text-green-600">Industry leading precision</div>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg">
              <div class="font-semibold text-blue-800">Processing Speed</div>
              <div class="text-sm font-bold text-blue-700">${BIM_CAPABILITIES.processing_speed}</div>
            </div>
            <div class="bg-purple-50 p-3 rounded-lg">
              <div class="font-semibold text-purple-800">AI Features</div>
              <div class="text-xs text-purple-600">
                ✅ Element Classification<br>
                ✅ Clash Detection<br>
                ✅ Cost Optimization
              </div>
            </div>
          </div>
          
          <div class="mt-6 bg-amber-50 border border-amber-200 rounded-lg p-4">
            <h4 class="font-semibold text-amber-800 mb-2">Enterprise Pricing</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <div class="font-medium">Setup & Implementation</div>
                <div class="text-xl font-bold text-amber-700">$${ENTERPRISE_PRICING.setup_fee.toLocaleString()}</div>
                <div class="text-xs text-amber-600">One-time fee includes training</div>
              </div>
              <div>
                <div class="font-medium">Monthly Subscription</div>
                <div class="text-xl font-bold text-amber-700">$${ENTERPRISE_PRICING.monthly_subscription.toLocaleString()}</div>
                <div class="text-xs text-amber-600">Per month, all features included</div>
              </div>
            </div>
            <div class="mt-3 text-xs text-amber-700">
              Volume discounts: 15% (10+ projects), 25% (25+ projects), 35% (50+ projects)
            </div>
          </div>
          
          <div class="flex gap-3 mt-6">
            <button onclick="requestEnterpriseDemo()" class="bg-amber-500 text-white px-4 py-2 rounded flex-1">Request Demo</button>
            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-4 py-2 rounded">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function getFormatDescription(format) {
      const descriptions = {
        'DWG': 'AutoCAD Drawing',
        'DXF': 'Drawing Exchange',
        'IFC': 'Industry Foundation Classes',
        'RVT': 'Revit Project',
        'SKP': 'SketchUp Model',
        'PLN': 'ArchiCAD Project',
        'PDF': 'Architectural Plans'
      };
      return descriptions[format] || format;
    }

    function generateQsReport() {
      if (!cadProcessingResults || Object.keys(cadProcessingResults).length === 0) {
        alert('Please process CAD files first to generate a QS report.');
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[80vh] overflow-y-auto">
          <h3 class="text-lg font-semibold mb-4">📊 Generate Professional QS Report</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            ${Object.entries(QS_REPORT_TEMPLATES).map(([key, template]) => `
              <div class="border rounded-lg p-3 cursor-pointer hover:bg-gray-50" onclick="selectReportTemplate('${key}')">
                <div class="font-medium">${template.name}</div>
                <div class="text-xs text-gray-600 mt-1">${template.sections.join(', ')}</div>
              </div>
            `).join('')}
          </div>
          
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <h4 class="font-semibold text-blue-800 mb-2">Report Contents</h4>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div>✅ Executive Summary</div>
              <div>✅ Detailed Quantities</div>
              <div>✅ Cost Breakdown by Trade</div>
              <div>✅ Material Specifications</div>
              <div>✅ Labor Allocation</div>
              <div>✅ Risk Analysis</div>
              <div>✅ Cash Flow Projections</div>
              <div>✅ Procurement Schedule</div>
            </div>
          </div>
          
          <div class="flex gap-3">
            <button onclick="downloadQsReport()" class="bg-blue-500 text-white px-4 py-2 rounded flex-1">Generate Report</button>
            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function selectReportTemplate(templateKey) {
      // Highlight selected template
      document.querySelectorAll('.cursor-pointer').forEach(el => {
        el.classList.remove('bg-blue-100', 'border-blue-300');
      });
      event.target.closest('.cursor-pointer').classList.add('bg-blue-100', 'border-blue-300');
      window.selectedReportTemplate = templateKey;
    }

    function downloadQsReport() {
      const template = window.selectedReportTemplate || 'elemental_cost_plan';
      
      // Generate comprehensive QS report content
      const reportContent = generateReportContent(template);
      
      const blob = new Blob([reportContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `QS_Report_${template}_${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      document.querySelector('.fixed').remove();
      alert('Professional QS Report generated successfully!\n\nNote: Enterprise edition includes formatted PDF/Excel reports with charts, 3D visualizations, and detailed cost analysis.');
    }

    function generateReportContent(template) {
      const results = cadProcessingResults;
      const templateData = QS_REPORT_TEMPLATES[template];
      
      return `
ESTIMATE PROFESSIONAL QUANTITY SURVEYOR REPORT
${templateData.name}
Generated: ${new Date().toLocaleDateString()}
Project: BIM Auto-Takeoff Analysis

=================================================

EXECUTIVE SUMMARY
=================================================
Total Project Cost: $${results.estimated_cost.toLocaleString()} AUD
Total Floor Area: ${results.total_area.toLocaleString()} m²
Number of Levels: ${results.levels}
Elements Detected: ${results.elements_detected.toLocaleString()}
Measurement Accuracy: ±2%

DETAILED COST BREAKDOWN
=================================================
${Object.entries(results.categories).map(([category, data]) => 
  `${category.replace(/_/g, ' ').toUpperCase().padEnd(25)} ${data.quantity.toLocaleString().padStart(10)} ${data.unit.padStart(8)} $${data.cost.toLocaleString().padStart(12)}`
).join('\n')}

SUBTOTAL (Construction):                                    $${Object.values(results.categories).reduce((sum, cat) => sum + cat.cost, 0).toLocaleString()}
Overheads (15%):                                           $${Math.round(Object.values(results.categories).reduce((sum, cat) => sum + cat.cost, 0) * 0.15).toLocaleString()}
Profit (12%):                                              $${Math.round(Object.values(results.categories).reduce((sum, cat) => sum + cat.cost, 0) * 0.12).toLocaleString()}
Contingency (8%):                                          $${Math.round(Object.values(results.categories).reduce((sum, cat) => sum + cat.cost, 0) * 0.08).toLocaleString()}
GST (10%):                                                 $${Math.round(results.estimated_cost * 0.10).toLocaleString()}

TOTAL PROJECT COST:                                        $${results.estimated_cost.toLocaleString()} AUD

=================================================
Generated by EstiMate Enterprise BIM Auto-Takeoff
Accuracy Guarantee: ±2%
Processing Time: 15-45 minutes
AI-Powered Element Detection: ${results.elements_detected.toLocaleString()} elements classified
=================================================

Note: This is a demonstration report. Enterprise edition provides:
- Detailed material specifications and suppliers
- Labor breakdown by trade with hourly rates  
- Cash flow projections and milestone payments
- Risk analysis and contingency recommendations
- 3D visualization and markup capabilities
- Direct integration with procurement systems
- Real-time cost updates and market pricing
      `;
    }

    function requestEnterpriseDemo() {
      const demoMessage = `EstiMate Enterprise BIM Auto-Takeoff Demo Request

Thank you for your interest in replacing your QS department with AI automation.

Enterprise Features:
🤖 Automated CAD/BIM processing (DWG, IFC, Revit, etc.)
📐 ±2% measurement accuracy guarantee
⚡ 15-45 minute complete takeoffs
📊 AIQS compliant elemental cost plans
🔍 Clash detection and design optimization
📈 Multi-option cost comparison analysis
🎯 Procurement-ready BOM schedules
🔗 Full API integration capabilities
👨‍💼 Dedicated account management
🎓 Complete team training and implementation

Investment:
• Setup Fee: $15,000 (includes training & implementation)
• Monthly Subscription: $2,999/month
• Volume discounts available for high-volume users

ROI Calculation:
• Replace 2-3 QS staff ($180k-270k annual salaries)
• 90% faster takeoff generation
• Eliminate human measurement errors
• 24/7 processing capability
• Typical payback period: 6-8 months

We'll contact you within 24 hours to schedule a personalized demo with your actual project files.

Contact: enterprise@estimate.com.au
Phone: 1800-ESTIMATE`;

      alert(demoMessage);
      document.querySelector('.fixed').remove();
    }

    function showRatesSchedule() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-6xl w-full max-h-[80vh] overflow-y-auto">
          <h3 class="text-lg font-semibold mb-4">🗂️ Australian Construction Rates Schedule</h3>
          
          <div class="mb-4">
            <div class="flex gap-2 mb-3">
              <button onclick="filterRates('all')" class="rates-filter-btn active bg-blue-500 text-white px-3 py-1 rounded text-sm">All</button>
              <button onclick="filterRates('preliminaries')" class="rates-filter-btn bg-gray-200 px-3 py-1 rounded text-sm">Preliminaries</button>
              <button onclick="filterRates('electrical')" class="rates-filter-btn bg-gray-200 px-3 py-1 rounded text-sm">Electrical</button>
              <button onclick="filterRates('plumbing')" class="rates-filter-btn bg-gray-200 px-3 py-1 rounded text-sm">Plumbing</button>
              <button onclick="filterRates('hvac')" class="rates-filter-btn bg-gray-200 px-3 py-1 rounded text-sm">HVAC</button>
              <button onclick="filterRates('labour_rates')" class="rates-filter-btn bg-gray-200 px-3 py-1 rounded text-sm">Labour</button>
            </div>
            <input type="text" id="rates-search" placeholder="Search rates..." class="w-full p-2 border rounded text-sm" onkeyup="searchRates()">
          </div>
          
          <div id="rates-display" class="space-y-4">
            ${generateRatesDisplay()}
          </div>
          
          <div class="flex gap-3 mt-6">
            <button onclick="exportRatesSchedule()" class="bg-green-500 text-white px-4 py-2 rounded">Export Schedule</button>
            <button onclick="generateClientReport()" class="bg-blue-500 text-white px-4 py-2 rounded">Generate Client Report</button>
            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-4 py-2 rounded">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function generateRatesDisplay() {
      let html = '';
      for (const [category, items] of Object.entries(AUSTRALIAN_RATES_SCHEDULE)) {
        html += `
          <div class="rates-category" data-category="${category}">
            <h4 class="font-semibold text-gray-800 mb-2 capitalize">${category.replace(/_/g, ' ')}</h4>
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="grid grid-cols-1 gap-2">
        `;
        
        for (const [itemKey, item] of Object.entries(items)) {
          if (typeof item === 'object' && item.rate) {
            html += `
              <div class="rates-item flex justify-between items-center p-2 bg-white rounded border text-sm" data-search="${item.description.toLowerCase()}">
                <div class="flex-1">
                  <div class="font-medium">${item.description}</div>
                  <div class="text-xs text-gray-500">${itemKey.replace(/_/g, ' ')}</div>
                </div>
                <div class="text-right">
                  <div class="font-semibold">$${item.rate.toLocaleString()}</div>
                  <div class="text-xs text-gray-500">per ${item.unit}</div>
                </div>
              </div>
            `;
          }
        }
        
        html += `
              </div>
            </div>
          </div>
        `;
      }
      return html;
    }

    function filterRates(category) {
      // Update button states
      document.querySelectorAll('.rates-filter-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-blue-500', 'text-white');
        btn.classList.add('bg-gray-200');
      });
      event.target.classList.add('active', 'bg-blue-500', 'text-white');
      event.target.classList.remove('bg-gray-200');
      
      // Show/hide categories
      document.querySelectorAll('.rates-category').forEach(cat => {
        if (category === 'all' || cat.dataset.category === category) {
          cat.style.display = 'block';
        } else {
          cat.style.display = 'none';
        }
      });
    }

    function searchRates() {
      const searchTerm = document.getElementById('rates-search').value.toLowerCase();
      document.querySelectorAll('.rates-item').forEach(item => {
        const searchData = item.dataset.search;
        if (searchData.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function exportRatesSchedule() {
      let csvContent = 'Category,Item,Description,Rate,Unit\n';
      
      for (const [category, items] of Object.entries(AUSTRALIAN_RATES_SCHEDULE)) {
        for (const [itemKey, item] of Object.entries(items)) {
          if (typeof item === 'object' && item.rate) {
            csvContent += `"${category}","${itemKey}","${item.description}","${item.rate}","${item.unit}"\n`;
          }
        }
      }
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Australian_Construction_Rates_Schedule_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      alert('Australian Construction Rates Schedule exported successfully!');
    }

    function generateClientReport() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[80vh] overflow-y-auto">
          <h3 class="text-lg font-semibold mb-4">📊 Professional Client Report Generator</h3>
          
          <div class="space-y-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Project Name</label>
                <input type="text" id="project-name" placeholder="Enter project name" class="w-full p-2 border rounded">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Client Name</label>
                <input type="text" id="client-name" placeholder="Enter client name" class="w-full p-2 border rounded">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Project Type</label>
                <select id="project-type" class="w-full p-2 border rounded">
                  <option value="residential">Residential</option>
                  <option value="commercial">Commercial</option>
                  <option value="retail">Retail</option>
                  <option value="hospitality">Hospitality</option>
                  <option value="industrial">Industrial</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Project Size (m²)</label>
                <input type="number" id="project-size" placeholder="Enter area" class="w-full p-2 border rounded">
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-1">Report Type</label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                ${Object.entries(QS_REPORT_TEMPLATES).map(([key, template]) => `
                  <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50">
                    <input type="radio" name="report-type" value="${key}" class="mr-2">
                    <div>
                      <div class="font-medium">${template.name}</div>
                      <div class="text-xs text-gray-600">${template.sections.slice(0, 3).join(', ')}...</div>
                    </div>
                  </label>
                `).join('')}
              </div>
            </div>
          </div>
          
          <div class="flex gap-3">
            <button onclick="generateProfessionalReport()" class="bg-blue-500 text-white px-4 py-2 rounded flex-1">Generate Report</button>
            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function generateProfessionalReport() {
      const projectName = document.getElementById('project-name').value || 'Project';
      const clientName = document.getElementById('client-name').value || 'Client';
      const projectType = document.getElementById('project-type').value;
      const projectSize = document.getElementById('project-size').value || '1000';
      const reportType = document.querySelector('input[name="report-type"]:checked')?.value || 'client_report';
      
      // Generate comprehensive professional report
      const reportContent = generateProfessionalReportContent({
        projectName,
        clientName,
        projectType,
        projectSize: parseInt(projectSize),
        reportType
      });
      
      const blob = new Blob([reportContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${projectName}_${reportType}_${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      document.querySelector('.fixed').remove();
      document.querySelector('.fixed').remove(); // Close both modals
      
      alert(`Professional ${QS_REPORT_TEMPLATES[reportType].name} generated successfully!\n\nNote: Enterprise edition includes:\n• Formatted PDF reports with company branding\n• Excel cost models with formulas\n• 3D visualizations and charts\n• Direct client portal access\n• Real-time cost updates`);
    }

    function generateProfessionalReportContent({ projectName, clientName, projectType, projectSize, reportType }) {
      const template = QS_REPORT_TEMPLATES[reportType];
      const estimatedCost = calculateProjectCost(projectType, projectSize);
      
      return `
ESTIMATE AUSTRALIA - PROFESSIONAL QUANTITY SURVEYOR REPORT
${template.name}
Generated: ${new Date().toLocaleDateString()}
Prepared by: Chartered Quantity Surveyors

=================================================
PROJECT INFORMATION
=================================================
Project Name: ${projectName}
Client: ${clientName}
Project Type: ${projectType.charAt(0).toUpperCase() + projectType.slice(1)}
Total Floor Area: ${projectSize.toLocaleString()} m²
Report Type: ${template.name}

=================================================
EXECUTIVE SUMMARY
=================================================
Total Estimated Project Cost: $${estimatedCost.total.toLocaleString()} AUD (excl. GST)
Cost per Square Metre: $${Math.round(estimatedCost.total / projectSize).toLocaleString()}/m²
Contingency Allowance: 7% ($${Math.round(estimatedCost.total * 0.07).toLocaleString()})
Total including Contingency: $${Math.round(estimatedCost.total * 1.07).toLocaleString()} AUD (excl. GST)
GST (10%): $${Math.round(estimatedCost.total * 1.07 * 0.10).toLocaleString()}
TOTAL INCLUDING GST: $${Math.round(estimatedCost.total * 1.07 * 1.10).toLocaleString()} AUD

=================================================
DETAILED COST BREAKDOWN
=================================================

1. PRELIMINARIES & SITE FACILITIES              $${estimatedCost.preliminaries.toLocaleString()}
   - Site establishment and facilities
   - Management and supervision
   - Temporary works and services
   - Insurance and bonds

2. SUBSTRUCTURE                                  $${estimatedCost.substructure.toLocaleString()}
   - Excavation and site preparation
   - Foundations and footings
   - Basement construction (if applicable)

3. SUPERSTRUCTURE                                $${estimatedCost.superstructure.toLocaleString()}
   - Structural frame and floors
   - External walls and cladding
   - Roof structure and covering

4. INTERNAL FINISHES                             $${estimatedCost.finishes.toLocaleString()}
   - Wall finishes and partitions
   - Floor finishes
   - Ceiling systems

5. FITTINGS & FIXTURES                           $${estimatedCost.fittings.toLocaleString()}
   - Built-in furniture and joinery
   - Specialist equipment
   - Signage and wayfinding

6. SERVICES                                      $${estimatedCost.services.toLocaleString()}
   - Electrical installation
   - Plumbing and drainage
   - HVAC systems
   - Fire services and security

7. EXTERNAL WORKS                                $${estimatedCost.external.toLocaleString()}
   - Site works and landscaping
   - Car parking and access roads
   - External services connections

CONSTRUCTION SUBTOTAL:                           $${estimatedCost.total.toLocaleString()}

=================================================
RATES SCHEDULE SUMMARY
=================================================
Based on Australian Construction Industry Standards:

LABOUR RATES (per hour):
- Carpenter: $65.00
- Electrician: $85.00
- Plumber: $82.00
- Labourer: $45.00

MATERIAL RATES (selected items):
- Concrete slab: $165/m²
- Steel frame: $1,230/tonne
- Electrical rough-in: $${projectType === 'residential' ? '60' : '85'}/m²
- Plumbing rough-in: $${projectType === 'residential' ? '50' : '77'}/m²
- HVAC system: $${projectType === 'residential' ? '85' : '180'}/m²

=================================================
ASSUMPTIONS & EXCLUSIONS
=================================================
ASSUMPTIONS:
- Standard site conditions
- Normal working hours (day shifts)
- Access to services available
- Standard soil conditions
- Current market pricing (${new Date().getFullYear()})

EXCLUSIONS:
- Site purchase costs
- Professional design fees
- Development approval fees
- Furniture and loose equipment
- Escalation beyond 12 months

=================================================
RISK FACTORS
=================================================
- Market price fluctuations
- Site condition variations
- Design changes during construction
- Weather and seasonal impacts
- Supply chain disruptions

=================================================
RECOMMENDATIONS
=================================================
1. Proceed with detailed design development
2. Obtain firm quotations for major elements
3. Consider value engineering opportunities
4. Plan for 6-month construction program
5. Engage experienced contractor early

=================================================
REPORT VALIDATION
=================================================
This report has been prepared based on:
- Current Australian market rates
- AIQS professional standards
- Industry best practices
- Regional cost variations

Accuracy: ±15% at current design stage
Valid for: 6 months from date of issue
Currency: Australian Dollars (AUD)

=================================================
Generated by EstiMate Professional QS Platform
Chartered Quantity Surveyors
AIQS Member Firm
www.estimate.com.au
=================================================
      `;
    }

    function calculateProjectCost(projectType, projectSize) {
      const baseCosts = {
        residential: {
          preliminaries: 180,
          substructure: 165,
          superstructure: 850,
          finishes: 450,
          fittings: 280,
          services: 320,
          external: 150
        },
        commercial: {
          preliminaries: 250,
          substructure: 195,
          superstructure: 1200,
          finishes: 650,
          fittings: 450,
          services: 580,
          external: 220
        },
        retail: {
          preliminaries: 220,
          substructure: 180,
          superstructure: 980,
          finishes: 750,
          fittings: 650,
          services: 480,
          external: 180
        },
        hospitality: {
          preliminaries: 280,
          substructure: 210,
          superstructure: 1100,
          finishes: 850,
          fittings: 850,
          services: 650,
          external: 250
        },
        industrial: {
          preliminaries: 160,
          substructure: 145,
          superstructure: 650,
          finishes: 280,
          fittings: 180,
          services: 350,
          external: 120
        }
      };
      
      const costs = baseCosts[projectType] || baseCosts.residential;
      const calculated = {};
      let total = 0;
      
      for (const [category, rate] of Object.entries(costs)) {
        calculated[category] = Math.round(rate * projectSize);
        total += calculated[category];
      }
      
      calculated.total = total;
      return calculated;
    }

    // Override addCustomMaterial for Pro features
    window.addCustomMaterial = () => {
      const name = document.getElementById('custom-mat-name').value.trim();
      const category = document.getElementById('custom-mat-category')?.value || 'flooring';
      const color = document.getElementById('custom-mat-color').value;
      const unit = document.getElementById('custom-mat-unit')?.value || 'm²';
      const materialCost = parseFloat(document.getElementById('custom-mat-material-cost')?.value) || 0;
      const laborCost = parseFloat(document.getElementById('custom-mat-labor-cost')?.value) || 0;
      const wastage = parseFloat(document.getElementById('custom-mat-wastage')?.value || 0) / 100;
      
      if (!name) {
        alert('Please enter a material name.');
        return;
      }
      if (materialCost <= 0 && laborCost <= 0) {
        alert('Please enter valid costs.');
        return;
      }
      
      const materialKey = name.toLowerCase().replace(/\s+/g, '_');
      MATERIALS[materialKey] = {
        color,
        materialCost,
        laborCost,
        wastage,
        category,
        unit,
        description: name,
        isPro: true
      };
      
      // Add to material select
      const select = document.getElementById('material-select');
      const option = document.createElement('option');
      option.value = materialKey;
      option.textContent = `${name} ($${(materialCost + laborCost).toFixed(0)}/${unit})`;
      select.appendChild(option);
      
      // Clear form
      ['custom-mat-name', 'custom-mat-material-cost', 'custom-mat-labor-cost', 'custom-mat-wastage'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
      });
      
      alert(`Material "${name}" added successfully!`);
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      init();
      updateMaterialSelect();
      updateServicesDisplay();
    });

    // Add professional QS features promotion
    setTimeout(() => {
      const ad = document.createElement('div');
      ad.className = 'ad-banner';
      ad.innerHTML = '🏗️ EstiMate Pro QS Edition - Mini Quantity Surveyor with full Australian labor rates • <strong>Upgrade for $39.99/month</strong> to unlock professional features!';
      document.body.appendChild(ad);
      
      // Auto-hide after 15 seconds
      setTimeout(() => {
        if (ad.parentNode) {
          ad.style.transform = 'translateY(100%)';
          setTimeout(() => ad.remove(), 300);
        }
      }, 15000);
    }, 5000);
  </script>
</body>
</html>